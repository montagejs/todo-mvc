"use strict";module.exports=function(t,n){function e(t,n){return{promise:n}}function r(){return!1}function o(t,n,e){var r=this;try{t(n,e,function(t){if("function"!=typeof t)throw new TypeError("onCancel must be a function, got: "+O.toString(t));r._attachCancellationCallback(t)})}catch(o){return o}}function i(t){if(!this._isCancellable())return this;var n=this._onCancel();void 0!==n?O.isArray(n)?n.push(t):this._setOnCancel([n,t]):this._setOnCancel(t)}function a(){return this._onCancelField}function c(t){this._onCancelField=t}function s(){this._cancellationParent=void 0,this._onCancelField=void 0}function l(t,n){if(0!==(1&n)){this._cancellationParent=t;var e=t._branchesRemainingToCancel;void 0===e&&(e=0),t._branchesRemainingToCancel=e+1}0!==(2&n)&&t._isBound()&&this._setBoundTo(t._boundTo)}function u(t,n){0!==(2&n)&&t._isBound()&&this._setBoundTo(t._boundTo)}function f(){var n=this._boundTo;return void 0!==n&&n instanceof t?n.isFulfilled()?n.value():void 0:n}function d(){this._trace=new F(this._peekContext())}function p(t,n){if(A(t)){var e=this._trace;if(void 0!==e&&n&&(e=e._parent),void 0!==e)e.attachExtraTrace(t);else if(!t.__stackCleaned__){var r=b(t);O.notEnumerableProp(t,"stack",r.message+"\n"+r.stack.join("\n")),O.notEnumerableProp(t,"__stackCleaned__",!0)}}}function h(t,n,e,r,o){if(void 0===t&&null!==n&&K){if(void 0!==o&&o._returnedNonUndefined())return;if(0===(65535&r._bitField))return;e&&(e+=" ");var i="",a="";if(n._trace){for(var c=n._trace.stack.split("\n"),s=k(c),l=s.length-1;l>=0;--l){var u=s[l];if(!P.test(u)){var f=u.match(H);f&&(i="at "+f[1]+":"+f[2]+":"+f[3]+" ");break}}if(s.length>0)for(var d=s[0],l=0;l<c.length;++l)if(c[l]===d){l>0&&(a="\n"+c[l-1]);break}}var p="a promise was created in a "+e+"handler "+i+"but was not returned from it, see http://goo.gl/rRqMUw"+a;r._warn(p,!0,n)}}function v(t,n){var e=t+" is deprecated and will be removed in a future version.";return n&&(e+=" Use "+n+" instead."),_(e)}function _(n,e,r){if(ot.warnings){var o,i=new D(n);if(e)r._attachExtraTrace(i);else if(ot.longStackTraces&&(o=t._peekContext()))o.attachExtraTrace(i);else{var a=b(i);i.stack=a.message+"\n"+a.stack.join("\n")}Z("warning",i)||T(i,"",!0)}}function g(t,n){for(var e=0;e<n.length-1;++e)n[e].push("From previous event:"),n[e]=n[e].join("\n");return e<n.length&&(n[e]=n[e].join("\n")),t+"\n"+n.join("\n")}function m(t){for(var n=0;n<t.length;++n)(0===t[n].length||n+1<t.length&&t[n][0]===t[n+1][0])&&(t.splice(n,1),n--)}function y(t){for(var n=t[0],e=1;e<t.length;++e){for(var r=t[e],o=n.length-1,i=n[o],a=-1,c=r.length-1;c>=0;--c)if(r[c]===i){a=c;break}for(var c=a;c>=0;--c){var s=r[c];if(n[o]!==s)break;n.pop(),o--}n=r}}function k(t){for(var n=[],e=0;e<t.length;++e){var r=t[e],o="    (No stack trace)"===r||q.test(r),i=o&&nt(r);o&&!i&&($&&" "!==r.charAt(0)&&(r="    "+r),n.push(r))}return n}function E(t){for(var n=t.stack.replace(/\s+$/g,"").split("\n"),e=0;e<n.length;++e){var r=n[e];if("    (No stack trace)"===r||q.test(r))break}return e>0&&"SyntaxError"!=t.name&&(n=n.slice(e)),n}function b(t){var n=t.stack,e=t.toString();return n="string"==typeof n&&n.length>0?E(t):["    (No stack trace)"],{message:e,stack:"SyntaxError"==t.name?n:k(n)}}function T(t,n,e){if("undefined"!=typeof console){var r;if(O.isObject(t)){var o=t.stack;r=n+W(o,t)}else r=n+String(t);"function"==typeof B?B(r,e):"function"!=typeof console.log&&"object"!=typeof console.log||console.log(r)}}function w(t,n,e,r){var o=!1;try{"function"==typeof n&&(o=!0,"rejectionHandled"===t?n(r):n(e,r))}catch(i){x.throwLater(i)}"unhandledRejection"===t?Z(t,e,r)||o||T(e,"Unhandled rejection "):Z(t,r)}function C(t){var n;if("function"==typeof t)n="[function "+(t.name||"anonymous")+"]";else{n=t&&"function"==typeof t.toString?t.toString():O.toString(t);var e=/\[object [a-zA-Z0-9$_]+\]/;if(e.test(n))try{var r=JSON.stringify(t);n=r}catch(o){}0===n.length&&(n="(empty array)")}return"(<"+R(n)+">, no stack trace)"}function R(t){var n=41;return t.length<n?t:t.substr(0,n-3)+"..."}function S(){return"function"==typeof rt}function j(t){var n=t.match(et);if(n)return{fileName:n[1],line:parseInt(n[2],10)}}function U(t,n){if(S()){for(var e,r,o=t.stack.split("\n"),i=n.stack.split("\n"),a=-1,c=-1,s=0;s<o.length;++s){var l=j(o[s]);if(l){e=l.fileName,a=l.line;break}}for(var s=0;s<i.length;++s){var l=j(i[s]);if(l){r=l.fileName,c=l.line;break}}a<0||c<0||!e||!r||e!==r||a>=c||(nt=function(t){if(G.test(t))return!0;var n=j(t);return!!(n&&n.fileName===e&&a<=n.line&&n.line<=c)})}}function F(t){this._parent=t,this._promisesCreated=0;var n=this._length=1+(void 0===t?0:t._length);rt(this,F),n>32&&this.uncycle()}var N,L,B,I=t._getDomain,x=t._async,D=require("./errors").Warning,O=require("./util"),A=O.canAttachTrace,G=/[\\\/]bluebird[\\\/]js[\\\/](release|debug|instrumented)/,P=/\((?:timers\.js):\d+:\d+\)/,H=/[\/<\(](.+?):(\d+):(\d+)\)?\s*$/,q=null,W=null,$=!1,M=!(0==O.env("BLUEBIRD_DEBUG")||!O.env("BLUEBIRD_DEBUG")&&"development"!==O.env("NODE_ENV")),Q=!(0==O.env("BLUEBIRD_WARNINGS")||!M&&!O.env("BLUEBIRD_WARNINGS")),V=!(0==O.env("BLUEBIRD_LONG_STACK_TRACES")||!M&&!O.env("BLUEBIRD_LONG_STACK_TRACES")),K=0!=O.env("BLUEBIRD_W_FORGOTTEN_RETURN")&&(Q||!!O.env("BLUEBIRD_W_FORGOTTEN_RETURN"));t.prototype.suppressUnhandledRejections=function(){var t=this._target();t._bitField=t._bitField&-1048577|524288},t.prototype._ensurePossibleRejectionHandled=function(){0===(524288&this._bitField)&&(this._setRejectionIsUnhandled(),x.invokeLater(this._notifyUnhandledRejection,this,void 0))},t.prototype._notifyUnhandledRejectionIsHandled=function(){w("rejectionHandled",N,void 0,this)},t.prototype._setReturnedNonUndefined=function(){this._bitField=268435456|this._bitField},t.prototype._returnedNonUndefined=function(){return 0!==(268435456&this._bitField)},t.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var t=this._settledValue();this._setUnhandledRejectionIsNotified(),w("unhandledRejection",L,t,this)}},t.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=262144|this._bitField},t.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=this._bitField&-262145},t.prototype._isUnhandledRejectionNotified=function(){return(262144&this._bitField)>0},t.prototype._setRejectionIsUnhandled=function(){this._bitField=1048576|this._bitField},t.prototype._unsetRejectionIsUnhandled=function(){this._bitField=this._bitField&-1048577,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},t.prototype._isRejectionUnhandled=function(){return(1048576&this._bitField)>0},t.prototype._warn=function(t,n,e){return _(t,n,e||this)},t.onPossiblyUnhandledRejection=function(t){var n=I();L="function"==typeof t?null===n?t:O.domainBind(n,t):void 0},t.onUnhandledRejectionHandled=function(t){var n=I();N="function"==typeof t?null===n?t:O.domainBind(n,t):void 0};var X=function(){};t.longStackTraces=function(){if(x.haveItemsQueued()&&!ot.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");if(!ot.longStackTraces&&S()){var e=t.prototype._captureStackTrace,r=t.prototype._attachExtraTrace;ot.longStackTraces=!0,X=function(){if(x.haveItemsQueued()&&!ot.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");t.prototype._captureStackTrace=e,t.prototype._attachExtraTrace=r,n.deactivateLongStackTraces(),x.enableTrampoline(),ot.longStackTraces=!1},t.prototype._captureStackTrace=d,t.prototype._attachExtraTrace=p,n.activateLongStackTraces(),x.disableTrampolineIfNecessary()}},t.hasLongStackTraces=function(){return ot.longStackTraces&&S()};var z=function(){try{if("function"==typeof CustomEvent){var t=new CustomEvent("CustomEvent");return O.global.dispatchEvent(t),function(t,n){var e=new CustomEvent(t.toLowerCase(),{detail:n,cancelable:!0});return!O.global.dispatchEvent(e)}}if("function"==typeof Event){var t=new Event("CustomEvent");return O.global.dispatchEvent(t),function(t,n){var e=new Event(t.toLowerCase(),{cancelable:!0});return e.detail=n,!O.global.dispatchEvent(e)}}var t=document.createEvent("CustomEvent");return t.initCustomEvent("testingtheevent",!1,!0,{}),O.global.dispatchEvent(t),function(t,n){var e=document.createEvent("CustomEvent");return e.initCustomEvent(t.toLowerCase(),!1,!0,n),!O.global.dispatchEvent(e)}}catch(n){}return function(){return!1}}(),J=function(){return O.isNode?function(){return process.emit.apply(process,arguments)}:O.global?function(t){var n="on"+t.toLowerCase(),e=O.global[n];return!!e&&(e.apply(O.global,[].slice.call(arguments,1)),!0)}:function(){return!1}}(),Y={promiseCreated:e,promiseFulfilled:e,promiseRejected:e,promiseResolved:e,promiseCancelled:e,promiseChained:function(t,n,e){return{promise:n,child:e}},warning:function(t,n){return{warning:n}},unhandledRejection:function(t,n,e){return{reason:n,promise:e}},rejectionHandled:e},Z=function(t){var n=!1;try{n=J.apply(null,arguments)}catch(e){x.throwLater(e),n=!0}var r=!1;try{r=z(t,Y[t].apply(null,arguments))}catch(e){x.throwLater(e),r=!0}return r||n};t.config=function(n){if(n=Object(n),"longStackTraces"in n&&(n.longStackTraces?t.longStackTraces():!n.longStackTraces&&t.hasLongStackTraces()&&X()),"warnings"in n){var e=n.warnings;ot.warnings=!!e,K=ot.warnings,O.isObject(e)&&"wForgottenReturn"in e&&(K=!!e.wForgottenReturn)}if("cancellation"in n&&n.cancellation&&!ot.cancellation){if(x.haveItemsQueued())throw new Error("cannot enable cancellation after promises are in use");t.prototype._clearCancellationData=s,t.prototype._propagateFrom=l,t.prototype._onCancel=a,t.prototype._setOnCancel=c,t.prototype._attachCancellationCallback=i,t.prototype._execute=o,tt=l,ot.cancellation=!0}return"monitoring"in n&&(n.monitoring&&!ot.monitoring?(ot.monitoring=!0,t.prototype._fireEvent=Z):!n.monitoring&&ot.monitoring&&(ot.monitoring=!1,t.prototype._fireEvent=r)),t},t.prototype._fireEvent=r,t.prototype._execute=function(t,n,e){try{t(n,e)}catch(r){return r}},t.prototype._onCancel=function(){},t.prototype._setOnCancel=function(t){},t.prototype._attachCancellationCallback=function(t){},t.prototype._captureStackTrace=function(){},t.prototype._attachExtraTrace=function(){},t.prototype._clearCancellationData=function(){},t.prototype._propagateFrom=function(t,n){};var tt=u,nt=function(){return!1},et=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;O.inherits(F,Error),n.CapturedTrace=F,F.prototype.uncycle=function(){var t=this._length;if(!(t<2)){for(var n=[],e={},r=0,o=this;void 0!==o;++r)n.push(o),o=o._parent;t=this._length=r;for(var r=t-1;r>=0;--r){var i=n[r].stack;void 0===e[i]&&(e[i]=r)}for(var r=0;r<t;++r){var a=n[r].stack,c=e[a];if(void 0!==c&&c!==r){c>0&&(n[c-1]._parent=void 0,n[c-1]._length=1),n[r]._parent=void 0,n[r]._length=1;var s=r>0?n[r-1]:this;c<t-1?(s._parent=n[c+1],s._parent.uncycle(),s._length=s._parent._length+1):(s._parent=void 0,s._length=1);for(var l=s._length+1,u=r-2;u>=0;--u)n[u]._length=l,l++;return}}}},F.prototype.attachExtraTrace=function(t){if(!t.__stackCleaned__){this.uncycle();for(var n=b(t),e=n.message,r=[n.stack],o=this;void 0!==o;)r.push(k(o.stack.split("\n"))),o=o._parent;y(r),m(r),O.notEnumerableProp(t,"stack",g(e,r)),O.notEnumerableProp(t,"__stackCleaned__",!0)}};var rt=function(){var t=/^\s*at\s*/,n=function(t,n){return"string"==typeof t?t:void 0!==n.name&&void 0!==n.message?n.toString():C(n)};if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){Error.stackTraceLimit+=6,q=t,W=n;var e=Error.captureStackTrace;return nt=function(t){return G.test(t)},function(t,n){Error.stackTraceLimit+=6,e(t,n),Error.stackTraceLimit-=6}}var r=new Error;if("string"==typeof r.stack&&r.stack.split("\n")[0].indexOf("stackDetection@")>=0)return q=/@/,W=n,$=!0,function(t){t.stack=(new Error).stack};var o;try{throw new Error}catch(i){o="stack"in i}return"stack"in r||!o||"number"!=typeof Error.stackTraceLimit?(W=function(t,n){return"string"==typeof t?t:"object"!=typeof n&&"function"!=typeof n||void 0===n.name||void 0===n.message?C(n):n.toString()},null):(q=t,W=n,function(t){Error.stackTraceLimit+=6;try{throw new Error}catch(n){t.stack=n.stack}Error.stackTraceLimit-=6})}([]);"undefined"!=typeof console&&"undefined"!=typeof console.warn&&(B=function(t){console.warn(t)},O.isNode&&process.stderr.isTTY?B=function(t,n){var e=n?"[33m":"[31m";console.warn(e+t+"[0m\n")}:O.isNode||"string"!=typeof(new Error).stack||(B=function(t,n){console.warn("%c"+t,n?"color: darkorange":"color: red")}));var ot={warnings:Q,longStackTraces:!1,cancellation:!1,monitoring:!1};return V&&t.longStackTraces(),{longStackTraces:function(){return ot.longStackTraces},warnings:function(){return ot.warnings},cancellation:function(){return ot.cancellation},monitoring:function(){return ot.monitoring},propagateFromFunction:function(){return tt},boundValueFunction:function(){return f},checkForgottenReturns:h,setBounds:U,warn:_,deprecated:v,CapturedTrace:F,fireDomEvent:z,fireGlobalEvent:J}};