"use strict";module.exports=function(t,e){function n(t,e,n){this.promise=t,this.type=e,this.handler=n,this.called=!1,this.cancelPromise=null}function i(t){this.finallyHandler=t}function r(t,e){return null!=t.cancelPromise&&(arguments.length>1?t.cancelPromise._reject(e):t.cancelPromise._cancel(),t.cancelPromise=null,!0)}function l(){return o.call(this,this.promise._target()._settledValue())}function a(t){if(!r(this,t))return u.e=t,u}function o(n){var o=this.promise,s=this.handler;if(!this.called){this.called=!0;var h=this.isFinallyHandler()?s.call(o._boundValue()):s.call(o._boundValue(),n);if(void 0!==h){o._setReturnedNonUndefined();var d=e(h,o);if(d instanceof t){if(null!=this.cancelPromise){if(d._isCancelled()){var f=new c("late cancellation observer");return o._attachExtraTrace(f),u.e=f,u}d.isPending()&&d._attachCancellationCallback(new i(this))}return d._then(l,a,void 0,this,void 0)}}}return o.isRejected()?(r(this),u.e=n,u):(r(this),n)}var s=require("./util"),c=t.CancellationError,u=s.errorObj;return n.prototype.isFinallyHandler=function(){return 0===this.type},i.prototype._resultCancelled=function(){r(this.finallyHandler)},t.prototype._passThrough=function(t,e,i,r){return"function"!=typeof t?this.then():this._then(i,r,void 0,new n(this,e,t),void 0)},t.prototype.lastly=t.prototype["finally"]=function(t){return this._passThrough(t,0,o,o)},t.prototype.tap=function(t){return this._passThrough(t,1,o)},n};