var Component=require("montage/ui/component").Component,Sanitizer=require("./rich-text-sanitizer").Sanitizer,RichTextLinkPopup=require("../overlays/rich-text-linkpopup.reel").RichTextLinkPopup,RichTextResizer=require("../overlays/rich-text-resizer.reel").RichTextResizer,Promise=require("montage/core/promise").Promise,defaultUndoManager=require("montage/core/undo-manager").defaultUndoManager;exports.RichTextEditorBase=Component.specialize({_COMMANDS:{enumerable:!1,value:null},COMMANDS:{enumerable:!1,get:function(){return this._COMMANDS||(this._COMMANDS=[{property:"bold"},{property:"underline"},{property:"italic"},{property:"strikeThrough"},{property:"baselineShift",method:this._baselineShiftGetState},{property:"justify",method:this._justifyGetState},{property:"listStyle",method:this._listStyleGetState},{property:"fontName",method:this._fontNameGetState},{property:"fontSize"},{property:"backColor"},{property:"foreColor"}]),this._COMMANDS}},_overlays:{enumerable:!1,value:void 0},_overlaySlot:{enumerable:!1,value:null},_activeOverlay:{enumerable:!1,value:null},_innerElement:{enumerable:!1,value:null},_originalDomContent:{value:null},_undoManager:{enumerable:!1,value:void 0},_isTyping:{enumerable:!1,value:!1},_startTyping:{enumerable:!1,value:function(){return this._doingUndoRedo?void(this._isTyping=!1):void(this._isTyping||(this._isTyping=!0,this.undoManager&&this.undoManager.register("Typing",Promise.resolve([this._undo,this,"Typing",this._innerElement]))))}},_stopTyping:{enumerable:!1,value:function(){this._isTyping&&(this._isTyping=!1)}},_hasSelectionChangeEvent:{enumerable:!1,value:null},_uniqueId:{enumerable:!1,value:Math.floor(1e3*Math.random())+"-"+Math.floor(1e3*Math.random())},_contentInitialized:{enumerable:!1,value:!1},_needsAssignOriginalContent:{enumerable:!1,value:!0},_needsAssingValue:{enumerable:!1,value:!1},_setCaretAtEndOfContent:{enumerable:!1,value:!1},_selectionChangeTimer:{enumerable:!1,value:null},_hasFocus:{enumerable:!1,value:!1},_needsFocus:{value:!1},_isActiveElement:{enumerable:!1,value:!1},_readOnly:{enumerable:!1,value:!1},_value:{enumerable:!1,value:""},_textValue:{enumerable:!1,value:""},delegate:{enumerable:!0,value:null},_sanitizer:{enumerable:!1,value:void 0},_allowDrop:{enumerable:!1,value:!0},_getState:{value:function(e,t){var n,i=document.activeElement,a=this._innerElement;return a&&!this["_"+e+"_locked"]?(a&&a!=i&&a.focus(),n=document.queryCommandValue(t),"true"==n&&(n=!0),"false"==n&&(n=!1),a&&a!=i&&i.focus(),n):this["_"+e]}},_genericCommandGetter:{value:function(e,t){var n="_"+e;return this[n]=this._getState(e,t),this[n]}},_genericCommandSetter:{value:function(e,t,n){var i=this._getState(e,t);i!==n&&this.doAction(t,"boolean"!=typeof n&&n)}},_bold:{value:!1},_underline:{value:!1},_italic:{value:!1},_strikeThrough:{value:!1},_baselineShiftGetState:{enumerable:!1,value:function(){var e=document.activeElement,t=this._innerElement;return t&&!this._baselineShift_locked?(t!=e&&t.focus(),this._getState("baselineShift","subscript")?"subscript":this._getState("baselineShift","superscript")?"superscript":"baseline"):this._baselineShift}},_baselineShift:{value:"baseline"},_listStyleGetState:{enumerable:!1,value:function(){var e=document.activeElement,t=this._innerElement;return t&&!this._listStyle_locked?(t!=e&&t.focus(),this._getState("listStyle","insertorderedlist")?"ordered":this._getState("listStyle","insertunorderedlist")?"unordered":"none"):this._listStyle}},_listStyle:{value:"none"},_justifyGetState:{enumerable:!1,value:function(){var e=document.activeElement,t=this._innerElement;return t&&!this._justify_locked?(t!=e&&t.focus(),this._getState("justify","justifyleft")?"left":this._getState("justify","justifycenter")?"center":this._getState("justify","justifyright")?"right":this._getState("justify","justifyfull")?"full":"left"):this._justify}},_justify:{value:"left"},_fontNameGetState:{enumerable:!1,value:function(){var e=this._getState("fontName","fontname");return e&&(e=e.replace(/\"|\'/g,"")),e}},_fontName:{value:""},_fontSize:{value:0},_backColor:{value:""},_foreColor:{value:""},_updateStates:{enumerable:!0,value:function(){var e,t,n,i,a,s,r,o,l=this,h=this.COMMANDS,u=h.length;for(o=0;o<u;o++)e=h[o],"object"==typeof e&&(n=e.property,t=e.name||n.toLowerCase(),s=e.method||this._getState,r=this.getOwnPropertyChangeDescriptor(n),r&&(a=this["_"+n],i=s.call(this,n,t),i!==a&&(this["_"+n+"_locked"]=!0,this.dispatchBeforeOwnPropertyChange(n,a),this["_"+n]=i,this.dispatchOwnPropertyChange(n,i),l["_"+n+"_locked"]=!1)))}},enterDocument:{value:function(e){var t;e&&(t=this.element,t.classList.add("montage-Editor-container"),t.addEventListener("focus",this,!0),t.addEventListener("dragstart",this,!1),t.addEventListener("dragenter",this,!1),t.addEventListener("dragover",this,!1),t.addEventListener("drop",this,!1),t.addEventListener("dragend",this,!1),void 0===this._sanitizer&&(this._sanitizer=new Sanitizer),void 0===this._undoManager&&(this._undoManager=defaultUndoManager),void 0===this._overlays&&(this._overlays=[new RichTextResizer,new RichTextLinkPopup]),this._callOverlays("initWithEditor",this,!0))}},draw:{enumerable:!1,value:function(){var e,t,n,i,a,s=this.element;if(this._needsAssingValue||this._needsAssignOriginalContent){if(e=this._innerElement=s.querySelector(".matte-Editor"),this._contentInitialized&&(s.replaceChild(e.cloneNode(!0),e),e=this._innerElement=s.querySelector(".matte-Editor")),e.setAttribute("contenteditable",this._readOnly?"false":"true"),e.classList.add("editor-"+this._uniqueId),e.innerHTML="",this._needsAssingValue)this._value&&!this._dirtyValue?e.innerHTML=this._value:this._textValue&&!this._dirtyTextValue&&(e.innerText?e.innerText=this._textValue:e.textContent=this._textValue);else if(this._needsAssignOriginalContent){if(t=this._originalDomContent,i=!1,t instanceof Element)e.appendChild(t),i=!0;else for(a=0;t&&(n=t[a]);a++)e.appendChild(n),i=!0;i&&(this._dirtyValue=!0,this._dirtyTextValue=!0)}this._adjustPadding(),this.markDirty(),this._needsAssingValue=!1,this._needsAssignOriginalContent=!1,this._contentInitialized=!0,this._setCaretAtEndOfContent=!0,this.hasFocus&&this.focus()}else e=this._innerElement;this._readOnly?(e.setAttribute("contentEditable","false"),s.classList.add("readonly")):(e.setAttribute("contentEditable","true"),s.classList.remove("readonly"))}},didDraw:{value:function(){if(this._needsFocus)if(this._innerElement.focus(),document.activeElement==this._innerElement)this._needsFocus=!1;else{var e=window.getComputedStyle(this.element);"hidden"==e.getPropertyValue("visibility")||"none"==e.getPropertyValue("display")?this._needsFocus=!1:this.needsDraw=!0}}},slotDidSwitchContent:{enumerable:!1,value:function(e,t,n,i,a){a&&"function"==typeof a.didBecomeInactive&&a.didBecomeInactive(),n&&"function"==typeof n.didBecomeActive&&n.didBecomeActive()}},_adjustPadding:{enumerable:!1,value:function(){var e=this._innerElement,t=0,n=0,i=function(e,a,s){var r,o=e?e.childNodes:[],l=o.length,h=e.offsetLeft,u=e.offsetTop;for(e.offsetParent&&(h+=a,u+=s),t>h&&(t=h),n>u&&(n=u),r=0;r<l;r++)i(o[r],h,u)};i(e,e.offsetLeft,e.offsetTop);var a=document.defaultView.getComputedStyle(e),s=a.paddingLeft,r=a.paddingTop;s=s.match(/%$/)?parseInt(s,10)*e.clientWidth:parseInt(s,10),r=r.match(/%$/)?parseInt(r,10)*e.clientHeight:parseInt(r,10),t<0&&(e.style.paddingLeft=-t-s+"px"),n<0&&(e.style.paddingTop=-n-r+"px")}},captureFocus:{enumerable:!1,value:function(){var e,t,n,i=this,a=this.element,s=this._innerElement;if(this.dispatchBeforeOwnPropertyChange("hasFocus",i._hasFocus),i._hasFocus=!0,this.dispatchOwnPropertyChange("hasFocus",i._hasFocus),e=s&&s===document.activeElement,e!=this._isActiveElement&&(this.dispatchBeforeOwnPropertyChange("isActiveElement",this._isActiveElement),i._isActiveElement=e,this.dispatchOwnPropertyChange("isActiveElement",this._isActiveElement)),this._setCaretAtEndOfContent){var r,o,l=this._lastInnerNode(),h=["#text","BR","IMG"];l&&(h.indexOf(l.nodeName)!==-1&&(l=l.parentNode),r=document.createRange(),o=l.childNodes?l.childNodes.length:0,r.setStart(l,o),r.setEnd(l,o),this._selectedRange=r),t=this._selectedRange,n=setInterval(function(){i._equalRange(i._selectedRange,t)&&s.scrollTop+s.offsetHeight!=s.scrollHeight&&(s.scrollTop=s.scrollHeight-s.offsetHeight)},10),setTimeout(function(){clearInterval(n)},1e3),this._setCaretAtEndOfContent=!1}if(a.addEventListener("blur",this,!0),a.addEventListener("input",this),a.addEventListener("keydown",this),a.addEventListener("keypress",this),a.addEventListener("cut",this),a.addEventListener("paste",this),a.addEventListener(window.Touch?"touchstart":"mousedown",this),document.addEventListener(window.Touch?"touchend":"mouseup",this),document.addEventListener("selectionchange",this,!1),null===this._hasSelectionChangeEvent){var i=this;setTimeout(function(){null===i._hasSelectionChangeEvent&&(i._hasSelectionChangeEvent=!1)},0)}this._hasSelectionChangeEvent===!1&&a.addEventListener("keydup",this),document.execCommand("enableObjectResizing",!1,!1),document.execCommand("styleWithCSS",!1,!0),this._updateStates()}},captureBlur:{enumerable:!1,value:function(){var e,t=this,n=this.element,i=this._innerElement;this.dispatchBeforeOwnPropertyChange("hasFocus",t._hasFocus),t._hasFocus=!1,this.dispatchOwnPropertyChange("hasFocus",t._hasFocus),e=i&&i===document.activeElement,e!=this._isActiveElement&&(this.dispatchBeforeOwnPropertyChange("isActiveElement",this._isActiveElement),t._isActiveElement=e,this.dispatchOwnPropertyChange("isActiveElement",this._isActiveElement)),this._selectionChangeTimer&&clearTimeout(this._selectionChangeTimer),n.removeEventListener("blur",this,!0),n.removeEventListener("input",this),n.removeEventListener("keydown",this),n.removeEventListener("keypress",this),n.removeEventListener("cut",this),n.removeEventListener("paste",this),n.removeEventListener(window.Touch?"touchstart":"mousedown",this),document.removeEventListener(window.Touch?"touchend":"mouseup",this),document.removeEventListener("selectionchange",this),this._hasSelectionChangeEvent===!1&&n.removeEventListener("keydup",this)}},handleKeydown:{enumerable:!1,value:function(e){["Left","Right","Up","Down","Home","End"].indexOf(e.keyIdentifier)!=-1&&this._stopTyping()}},handleKeypress:{enumerable:!1,value:function(){this._hasSelectionChangeEvent===!1&&this.handleSelectionchange(),this.markDirty()}},handleInput:{enumerable:!1,value:function(e){this._executingCommand||this._ignoreNextInputEvent||this._startTyping(),delete this._ignoreNextInputEvent,this._hasSelectionChangeEvent===!1&&this.handleSelectionchange(),this.handleDragend(e),this.markDirty()}},handleShortcut:{enumerable:!1,value:function(e,t){return this.doAction(t),!0}},handleMousedown:{enumerable:!1,value:function(e){this._savedSelection=this._selectedRange,this._callOverlays("mousedown"==e.type?"editorMouseDown":"editorTouchStart",e)}},handleMouseup:{enumerable:!1,value:function(e){this._equalRange(this._savedSelection,this._selectedRange)||this._stopTyping(),this._hasSelectionChangeEvent===!1&&this.handleSelectionchange(),this.handleDragend(e),this._callOverlays("mouseup"==e.type?"editorMouseUp":"editorTouchEnd",e)}},handleTouchstart:{enumerable:!1,value:function(){this.handleMousedown(event)}},handleTouchend:{enumerable:!1,value:function(){this.handleMouseup(event)}},handleSelectionchange:{enumerable:!1,value:function(){var e=this;null==this._hasSelectionChangeEvent&&(this._hasSelectionChangeEvent=!0),this._ignoreSelectionchange||this._equalRange(this._selectedRange,this._savedSelectedRange)||(this._savedSelectedRange=this._selectedRange,this._selectionChangeTimer&&clearTimeout(this._selectionChangeTimer),this._selectionChangeTimer=setTimeout(function(){e._updateStates(),e._dispatchEditorEvent("editorSelect")},100),this._callOverlays("editorSelectionDidChange",this._savedSelectedRange))}},handleDragstart:{enumerable:!1,value:function(e){var t=this._delegateMethod("canDrag");return t&&!t.call(this.delegate,this,e.srcElement)?(e.preventDefault(),void e.stopPropagation()):void(this._dragSourceElement=e.srcElement)}},handleDragenter:{enumerable:!1,value:function(e){this.hideOverlay();var t=this._delegateMethod("canDrop");t?this._allowDrop=t.call(this.delegate,this,e,this._dragSourceElement):this._allowDrop=!0,e.dataTransfer.dropEffect=this._allowDrop?"copy":"none"}},handleDragend:{enumerable:!1,value:function(e){delete this._dragSourceElement,delete this._dragOverX,delete this._dragOverY,this.handleSelectionchange()}},handleDragover:{enumerable:!1,value:function(e){var t,n=this;this._dragSourceElement&&this._allowDrop||(e.dataTransfer.dropEffect=this._allowDrop?"copy":"none",e.preventDefault(),e.stopPropagation(),!this._allowDrop||e.x===this._dragOverX&&e.y===this._dragOverY||(this._dragOverX=e.x,this._dragOverY=e.y,this._ignoreSelectionchange=!0,document.caretRangeFromPoint?t=document.caretRangeFromPoint(e.x,e.y):e.rangeParent&&e.rangeOffset&&(t=document.createRange(),t.setStart(e.rangeParent,e.rangeOffset),t.setEnd(e.rangeParent,e.rangeOffset)),t&&(this._selectedRange=t),this._ignoreSelectionchangeTimer&&clearTimeout(this._ignoreSelectionchangeTimer),this._ignoreSelectionchangeTimer=setTimeout(function(){delete n._ignoreSelectionchange,n._ignoreSelectionchangeTimer=null},0)))}},handleDrop:{enumerable:!1,value:function(e){var t,n,i,a,s,r,o=this,l=e.dataTransfer.files,h=l.length;if(this._dragSourceElement)return this._stopTyping(),this.undoManager&&this.undoManager.register("Move",Promise.resolve([this._undo,this,"Move",this._innerElement])),this._ignoreNextInputEvent=!0,this.handleDragend(e),void this.handleSelectionchange();if(e.preventDefault(),e.stopPropagation(),h)for(a=0;a<h;a++)t=l[a],s=this._delegateMethod("shouldDropFile"),r=!0,window.FileReader?(i=new FileReader,i.onload=function(){n=i.result,s&&(r=s.call(o.delegate,o,t,n)),r===!0?t.type.match(/^image\//i)&&(o.execCommand("insertimage",!1,n,"Drop"),o.markDirty()):"string"==typeof r&&(o.execCommand("inserthtml",!1,r,"Drop"),o.markDirty())},i.onprogress=function(e){},i.onerror=function(e){},i.readAsDataURL(t)):(s&&(r=s.call(this.delegate,this,t)),"string"==typeof r&&(o.execCommand("inserthtml",!1,r,"Drop"),o.markDirty()));else{if(n=e.dataTransfer.getData("text/html"))this._sanitizer&&(n=this._sanitizer.willInsertHtmlData(n,this._uniqueId));else if(n=e.dataTransfer.getData("text/plain")||e.dataTransfer.getData("text")){var u=document.createElement("div");u.innerText?u.innerText=n:u.textContent=n,n=u.innerHTML}if(n){var r,s=this._delegateMethod("shouldDrop");s?(r=s.call(this.delegate,this,e,n,"text/html"),n=r===!0?n.replace(/\<meta [^>]+>/gi,""):r===!1?null:r):n=n.replace(/\<meta [^>]+>/gi,""),n&&n.length&&(this.execCommand("inserthtml",!1,n,"Drop"),this.markDirty())}}this.handleDragend(e)}},handleCut:{enumerable:!1,value:function(e){this._stopTyping(),this.undoManager&&this.undoManager.register("Cut",Promise.resolve([this._undo,this,"Cut",this._innerElement])),this._ignoreNextInputEvent=!0}},handlePaste:{enumerable:!1,value:function(e){var t,n,i,a,s,r,o,l=this,h=e.clipboardData,u=h.getData("text/html");a=u&&u.match(/^(<meta [^>]*>|<html>)/i),u&&a?this._sanitizer&&(u=this._sanitizer.willInsertHtmlData(u,this._uniqueId)):(u=h.getData("text/plain")||h.getData("text"),u&&(i=document.createElement("div"),i.innerText?i.innerText=u:i.textContent=u,u=i.innerHTML)),u?(t=this._delegateMethod("shouldPaste"),t?(n=t.call(this.delegate,this,e,u,"text/html"),u=n===!0?u.replace(/\<meta [^>]+>/gi,""):n===!1?null:n):u=u.replace(/\<meta [^>]+>/gi,""),u&&u.length&&(this.execCommand("inserthtml",!1,u,"Paste"),this.markDirty())):h.items.length&&(s=h.items[0],"file"==s.kind&&s.type.match(/^image\/.*$/)&&(r=s.getAsFile(),n=!0,t=l._delegateMethod("shouldPasteFile"),window.FileReader?(o=new FileReader,o.onload=function(){u=o.result,t&&(n=t.call(l.delegate,l,r,u)),n===!0&&r.type.match(/^image\//i)&&(l.execCommand("insertimage",!1,u,"Paste"),l.markDirty())},o.onprogress=function(e){},o.onerror=function(e){},o.readAsDataURL(r)):t&&(n=t.call(this.delegate,this,r)))),e.preventDefault(),e.stopPropagation()}},handleAction:{enumerable:!1,value:function(e){var t=e.currentTarget,n=t.action||t.identifier,i=!1;n&&this.doAction(n,i)}},doAction:{enumerable:!0,value:function(e,t){this.execCommand(e,!1,t),this._updateStates()}},_undo:{enumerable:!1,value:function(e,t){var n=this._innerElement;t&&t!==n||(this._doingUndoRedo=!0,this._ignoreNextInputEvent=!0,document.execCommand("undo",!1,null),this.markDirty(),this.undoManager&&this.undoManager.register(e,Promise.resolve([this._redo,this,e,n])),this._doingUndoRedo=!1)}},_redo:{enumerable:!1,value:function(e,t){var n=this._innerElement;t&&t!==n||(this._doingUndoRedo=!0,this._ignoreNextInputEvent=!0,document.execCommand("redo",!1,null),this.markDirty(),this.undoManager&&this.undoManager.register(e,Promise.resolve([this._undo,this,e,n])),this._doingUndoRedo=!1)}},_execCommandLabel:{enumerable:!1,value:{bold:"Bold",italic:"Italic",underline:"Underline",strikethrough:"strikeThrough",subscript:"Subscript",superscript:"Superscript",indent:"Indent",outdent:"Outdent",insertorderedlist:"Ordered List",insertunorderedlist:"Unordered List",justifyleft:"Left Align",justifycenter:"Center",justifyright:"Right Align",justifyfull:"Justify",fontname:"Set Font",fontsize:"Set Size",forecolor:"Set Color",backcolor:"Set Color"}},_dispatchEditorEvent:{enumerable:!1,value:function(e,t){var n=document.createEvent("CustomEvent");n.initCustomEvent(e,!0,!1,void 0===t?null:t),n.type=e,this.dispatchEvent(n)}},_delegateMethod:{enumerable:!1,value:function(e){var t,n,i;return n="string"==typeof this.identifier?this.identifier+e.toCapitalized():e,(t=this.delegate)&&"function"==typeof(i=t[n])?i:null}},_callOverlays:{value:function(e,t,n){var i,a,s=this._activeOverlay;if(s&&"function"==typeof s[e]&&s[e](t)&&!n)return!0;for(i in this._overlays)if(a=this._overlays[i],a!==s&&"function"==typeof a[e]&&a[e](t)&&!n)return!0;return!1}},_nodeOffset:{enumerable:!1,value:function(e){var t,n=e.parentNode,i=n.childNodes;for(t in i)if(i[t]===e)return parseInt(t,10);return-1}},_lastInnerNode:{enumerable:!1,value:function(){for(var e=this._innerElement.childNodes,t=e.length,n=null;e&&(t=e.length);)n=e[t-1],e=n.childNodes;return n}},_selectedRange:{enumerable:!1,set:function(e){if(window.getSelection){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else e.select()},get:function(){var e,t;if(window.getSelection?e=window.getSelection():document.selection&&(e=document.selection.createRange()),e.getRangeAt)return e.rangeCount?e.getRangeAt(0):document.createRange();var t=document.createRange();return t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset),t}},_equalRange:{enumerable:!1,value:function(e,t){return e===t||!(!e||!t)&&(e.startContainer==t.startContainer&&e.startOffset==t.startOffset&&e.endContainer==t.endContainer&&e.endOffset==t.endOffset)}},_innerText:{enumerable:!1,value:function(e){var t="",n=[],i="",a=!1,s=function(e){var t,r=e.nodeName;if(!r.match(/^(TITLE|STYLE|SCRIPT)$/)){for(a&&r.match(/^(P|DIV|BR|TR|LI)$/)&&(i+="\n"),t=e.firstChild;t;t=t.nextSibling)3==t.nodeType?(n.push(i+t.nodeValue),i="",a=!0):("BR"!=t.nodeName||t.nextSibling)&&s(t);a&&r.match(/^(TABLE|UL|OL)$/)&&(i+="\n")}};return e&&(s(e),t=n.join("")),t}},deserializedFromTemplate:{value:function(){this._originalDomContent=this.domContent}}});