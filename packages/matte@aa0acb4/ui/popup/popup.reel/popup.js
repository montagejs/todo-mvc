var Component=require("montage/ui/component").Component,Popup=exports.Popup=Component.specialize({hasTemplate:{value:!0},anchorElement:{value:null},_anchor:{value:null},anchor:{get:function(){return this._anchor},set:function(t){t&&(this._anchor=t,t.nodeName?this.anchorElement=t:this.anchorElement=t.element)}},delegate:{value:null},contentEl:{value:null},containerEl:{value:null},_slot:{value:null},slot:{get:function(){return this._slot},set:function(t){this._slot=t,this.content&&(this._slot.content=this.content)}},_content:{value:null},content:{get:function(){return this._content},set:function(t){this._content!==t&&this.slot&&(this.slot.content=t),this._content=t,this._content.popup=this,this.needsDraw=!0}},_modal:{value:!1},modal:{get:function(){return this._modal},set:function(t){t=!!t,this._modal!==t&&(this._modal=t,this.needsDraw=!0)}},_position:{value:null},position:{get:function(){return this._position},set:function(t){this._position=t}},autoHide:{value:0},_displayed:{value:!1},displayed:{get:function(){return this._displayed},set:function(t){this._displayed!==t&&(this.needsDraw=!0),this._displayed=t}},focusOnShow:{value:!0},enterDocument:{value:function(t){t&&(this.type=this.type||"custom")}},_popupSlot:{value:null},_modalDialogMask:{value:null},_getElementPosition:{value:function(t){var e=0,i=0,n=0,o=0;if(t.offsetParent)do e+=t.offsetLeft,i+=t.offsetTop,n+=t.offsetHeight,o+=t.offsetWidth;while(t=t.offsetParent);return{top:i,left:e,height:n,width:o}}},_getCSSValue:{value:function(t){return null!=t?("number"==typeof t&&(t+="px"),t):""}},_positionPopup:{value:function(){var t,e,i=this.delegate,n=this.anchorElement;this.type;if(null!==this.position)t=this.position;else{var o=this.contentEl||this.content.element,s=parseFloat(o.style.height||0)||o.offsetHeight||0,l=parseFloat(o.style.width||0)||o.offsetWidth||0,a=window.innerHeight,h=window.innerWidth;if(n){var u=this._getElementPosition(n),d=parseFloat(n.style.height||0)||n.offsetHeight||0,c=parseFloat(n.style.width||0)||n.offsetWidth||0;t={top:u.top+d,left:u.left+c/2-l/2},t.left<0&&(t.left=u.left,this._showHidePointer(!1))}else t={top:a/2-s/2,left:h/2-l/2}}e=i&&"function"==typeof i.willPositionPopup?i.willPositionPopup(this,t):t;var r=this._popupSlot;e&&(r.element.style.top=this._getCSSValue(e.top),r.element.style.left=this._getCSSValue(e.left),r.element.style.right=this._getCSSValue(e.right),r.element.style.bottom=this._getCSSValue(e.bottom))}},_createModalMask:{value:function(){var t=document.createElement("div");return t.classList.add("montage-Popup-modal-mask"),t.style.zIndex=6999,t.classList.add("montage-invisible"),document.body.appendChild(t),t}},_showHidePointer:{value:function(t){}},_addEventListeners:{value:function(){window.Touch?this.element.ownerDocument.addEventListener("touchstart",this,!1):(this.element.ownerDocument.addEventListener("mousedown",this,!1),this.element.ownerDocument.addEventListener("keyup",this,!1)),window.addEventListener("resize",this)}},_removeEventListeners:{value:function(){window.Touch?this.element.ownerDocument.removeEventListener("touchstart",this,!1):(this.element.ownerDocument.removeEventListener("mousedown",this,!1),this.element.ownerDocument.removeEventListener("keyup",this,!1)),window.removeEventListener("resize",this)}},show:{value:function(){var t=this.type,e=this;this.application.getPopupSlot(t,this,function(t){e._popupSlot=t,e.displayed=!0,e._addEventListeners()})}},hide:{value:function(){var t=this.type,e=this;this.application.getPopupSlot(t,this,function(t){e._removeEventListeners(),e.displayed=!1})}},_showModalMask:{value:function(){this._modalDialogMask=document.querySelector("Popup-modal-mask"),this._modalDialogMask=this._modalDialogMask||this._createModalMask(),this._modalDialogMask.classList.remove("montage-invisible")}},_hideModalMask:{value:function(){var t=this.application._getActivePopupSlots(),e=0;if(t&&t.length>0){var i,n=t.length;for(i=0;i<n;i++)t[i].content&&t[i].content.modal===!0&&t[i].content.displayed===!0&&e++}e<=0&&this._modalDialogMask.classList.add("montage-invisible")}},draw:{value:function(){if(this.displayed){if(this.modal===!0)this.element.classList.add("montage-Popup--modal");else if(this.element.classList.remove("montage-Popup--modal"),this.autoHide){var t=this;setTimeout(function(){t.hide()},this.autoHide)}this.element.classList.remove("montage-invisible"),this.content.element.style.display="block",this.content.element.classList.remove("montage-invisible"),this.content.element.setAttribute("tabindex","0")}else this.element.classList.contains("montage-invisible")||this.element.classList.add("montage-invisible"),this.content.element.classList.add("montage-invisible"),this._popupSlot&&(this._popupSlot.content=null)}},didDraw:{value:function(){this._displayed?(this.modal===!0&&this._showModalMask(),this._positionPopup(),this.focusOnShow===!0&&this.content.element.focus()):this.modal===!0&&this._hideModalMask();var t=document.createEvent("CustomEvent");t.initCustomEvent(this._displayed===!0?"show":"hide",!0,!0,this),this.dispatchEvent(t)}},getZIndex:{value:function(t){for(var e,i,n;t&&t!==document;){if(e=t.style.position,("absolute"===e||"relative"===e||"fixed"===e)&&(n=t.style["z-index"],i=parseInt(n,10),!isNaN(i)&&0!==i))return i;t=t.parentNode}return 0}},_handleTouchMouseup:{value:function(t){var e=this.getZIndex(t.target),i=this.getZIndex(this.element);this.displayed===!0&&e<i&&(this.modal===!0||(this.displayed=!1))}},_timeoutId:{value:null},handleResize:{value:function(t){var e=this;this.displayed===!0&&(window.clearTimeout(this._timeoutId),this._timeoutId=setTimeout(function(){e.needsDraw=!0},100))}},handleMousedown:{value:function(t){this._handleTouchMouseup(t)}},handleTouchstart:{value:function(t){this._handleTouchMouseup(t)}},handleKeyup:{value:function(t){this.displayed!==!0||this.modal||27!==t.keyCode||this.hide()}}});