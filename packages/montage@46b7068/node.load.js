montageDefine("46b7068","node",{dependencies:["q-io/fs","./montage","mr","url","htmlparser2"],factory:function(n,e,t){function r(n){var e=l.directory(n);if(e===n)throw new Error("Can't find package");var t=l.join(e,"package.json");return l.stat(t).then(function(n){return n.isFile()?e:r(e)})}function o(){throw new Error("Can't load module that is not in a package")}function a(n,e){return h.loadPackage(n).then(function(t){var r=e.slice(n.length+1);return t.async(r)})}function i(n){var e,t,r=new d.DomHandler(function(n,r){t=n,e=r}),o=new d.Parser(r);if(o.write(n),o.done(),t)throw t;if(!e)throw new Error("HTML parsing did not complete");return{type:"document",children:e}}function c(n,e){var t,r=function(){t=!0};if(e(n,r),!t)for(var o=n.children,a=o?o.length:0,i=0;i<a;i++)c(o[i],e)}function u(n,e){return n.attribs?n.attribs[e]:null}function s(n){return g.getText(n)}function f(n){return n.replace(/\[[^\]]+\]$/,"")}var l=n("q-io/fs"),h=n("./montage"),p=n("mr"),m=n("url"),d=n("htmlparser2"),g=d.DomUtils;e.bootstrap=function(){var n=process.argv.slice(0,3),e=process.argv.slice(2),t=e.shift();return l.canonical(t).then(function(t){return r(t)["catch"](function(r){if("Can't find package"!==r.message)throw new Error(r);o(t,n,e)}).then(function(r){return a(r,t,n,e)})})},h.loadPackage=function(n,e){return"/"!==n.slice(n.length-1,n.length)&&(n+="/"),e=e||{},e.overlays=["node","server","montage"],e.location=m.resolve(p.getLocation(),n),p.loadPackage(e.location,e)},h.TemplateLoader=function(n,e){return function(n,t){var r=n.match(/(.*\/)?(?=[^\/]+\.html$)/),o=n.match(/(?=[^\/]+\.json$)/),a=n.match(/(.*\/)?([^\/]+)\.reel\/\2$/);return r?e(n,t).then(function(){return t.dependencies=v(t.text,t.location),t}):o?e(n,t).then(function(){return t.dependencies=w(t.text,[]),t}):a?e(n,t).then(function(){var e=m.resolve(t.location,a[2]+".html");return l.stat(m.parse(e).pathname).then(function(e){e.isFile()&&(t.extraDependencies=[n+".html"])},function(n){console.log(n.message)})}):e(n,t)}},p.makeLoader=function(n){return function(e){return h.TemplateLoader(e,n(e))}}(p.makeLoader);var v=function(n){var e=[],t=i(n);return y(t,e),e},y=function(n,e){c(n,function(n){g.isTag(n)&&("script"===n.name?"text/montage-serialization"===u(n,"type")&&w(s(n),e):"link"===n.name&&"text/montage-serialization"===u(n,"type")&&e.push(u(n,"href")))})},w=function(n,e){var t=JSON.parse(n);return Object.keys(t).forEach(function(n){var r=t[n];r.lazy||("string"==typeof r.prototype&&e.push(f(r.prototype)),"string"==typeof r.object&&e.push(f(r.object)))}),e}}});