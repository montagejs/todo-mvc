var Montage=require("./core").Montage,MessageFormat=require("./messageformat"),rootComponent=require("../ui/component").__root__,logger=require("./logger").logger("localizer"),Serializer=require("./serialization/serializer/montage-serializer").MontageSerializer,Deserializer=require("./serialization/deserializer/montage-deserializer").MontageDeserializer,Promise=require("./promise").Promise,Bindings=require("./core").Bindings,FrbBindings=require("frb/bindings"),stringify=require("frb/stringify"),expand=require("frb/expand"),Map=require("collections/map"),Scope=require("frb/scope");MessageFormat.locale=require("./messageformat-locale");var KEY_KEY="key",DEFAULT_MESSAGE_KEY="default",LOCALE_STORAGE_KEY="montage_locale",LOCALES_DIRECTORY="locale",MESSAGES_FILENAME="messages",MANIFEST_FILENAME="manifest.json",EMPTY_STRING_FUNCTION=function(){return""},reLanguageTagValidator=/^[a-zA-Z]+(?:-[a-zA-Z0-9]+)*$/,Localizer=exports.Localizer=Montage.specialize({initWithLocale:{value:function(e){var i;this.storesLocale&&"undefined"!=typeof window&&window.localStorage&&(i=window.localStorage.getItem(LOCALE_STORAGE_KEY));var t=e||i||window.navigator.userLanguage||window.navigator.language||Localizer.defaultLocale,a=this.callDelegateMethod("localizerWillUseLocale",this,t);return this.locale=a||t,this._isInitialized=!0,this.loadMessages(),this}},initWithLocaleAndDelegate:{value:function(e,i){return this.delegate=i,this.initWithLocale(e)}},storesLocale:{value:!1},component:{value:null},_delegate:{value:null},delegate:{set:function(e){!this._delegate&&e&&"object"==typeof e&&(this._delegate=e)},get:function(){return this._delegate}},_isInitialized:{value:!1},isInitialized:{get:function(){return this._isInitialized}},messageFormat:{serializable:!1,value:null},_messages:{value:null},messages:{get:function(){return this._messages},set:function(e){if(this._messages!==e){if(null!=e&&"object"!=typeof e)throw new TypeError(e," is not an object");this._messages=e}}},messagesPromise:{serializable:!1,value:null},_locale:{value:null},locale:{get:function(){return this._locale},set:function(e){if(!reLanguageTagValidator.test(e))throw new TypeError("Language tag '"+e+"' is not valid. It must match http://tools.ietf.org/html/rfc5646 (alphanumeric characters separated by hyphens)");if(this._locale!==e){var i=this._locale;if(this._locale=e,this.messageFormat=new MessageFormat(e),i&&i!==this._locale){var t=this;this.loadMessages().then(function(){t._dispatchLocaleChange(i)})}if(this.storesLocale&&"undefined"!=typeof window&&window.localStorage)try{window.localStorage.setItem(LOCALE_STORAGE_KEY,e)}catch(a){}}}},_availableLocales:{value:null},availableLocales:{get:function(){return this._availableLocales?this._availableLocales:this._availableLocales=this.callDelegateMethod("localizerWillPromiseAvailableLocales",this)||this._manifest.get("files").get(LOCALES_DIRECTORY).get("files").then(function(e){return Object.keys(e)})}},_require:{value:global.require},require:{serializable:!1,get:function(){return this._require},set:function(e){this._require!==e&&(this.__manifest=null,this._require=e)}},__manifest:{value:null},_manifest:{depends:["require"],get:function(){var e=this.require;return e.packageDescription.manifest===!0?this.__manifest?this.__manifest:this.__manifest=e.async(MANIFEST_FILENAME):Promise.reject(new Error("Package has no manifest. "+e.location+'package.json must contain "manifest": true and '+e.location+MANIFEST_FILENAME+" must exist"))}},loadMessagesTimeout:{value:5e3},loadMessages:{value:function(e,i){if(!this.require)throw new Error("Cannot load messages as",this,"require is not set");"number"!=typeof e&&(e=this.loadMessagesTimeout),this.messages=null;var t=this,a=this.callDelegateMethod("localizerWillLoadMessages",this);return this.hasOwnProperty("loadMessagesTimeout")&&(e=this.loadMessagesTimeout),a=a?a.timeout(e):this._manifest.timeout(e).then(function(e){return t._loadMessageFiles(e.files)}),this.messagesPromise=a.then(function(e){return t._collapseMessages(e)},function(e){throw console.error("Could not load messages for '"+t.locale+"': "+e),e}).then(function(e){return"function"==typeof i&&i(e),e})}},_loadMessageFiles:{value:function(e){var i=this.require;if(!e)return Promise.reject(new Error(i.location+MANIFEST_FILENAME+" does not contain a 'files' property"));var t,a,s,n,o=[];if(!(LOCALES_DIRECTORY in e))return Promise.reject(new Error("Package does not contain a '"+LOCALES_DIRECTORY+"' directory"));for(t=e[LOCALES_DIRECTORY].files,a=this._locale;""!==a;)t.hasOwnProperty(a)&&(s=t[a].files,(n=MESSAGES_FILENAME+".js")in s||(n=MESSAGES_FILENAME+".json")in s?o.push(i.async(LOCALES_DIRECTORY+"/"+a+"/"+n)):logger.isDebug&&logger.debug(this,"Warning: '"+LOCALES_DIRECTORY+"/"+a+"/' does not contain '"+MESSAGES_FILENAME+".json' or '"+MESSAGES_FILENAME+".js'")),a=a.substring(0,a.lastIndexOf("-"));if(!o.length)return Promise.reject(new Error("Could not find any "+MESSAGES_FILENAME+".json or "+MESSAGES_FILENAME+".js files"));var r=Promise.all(o);if(logger.isDebug){var l=this;r=r.then(function(e){return logger.debug(l,"loaded "+e.length+" message files"),e})}return r}},_collapseMessages:{value:function(e){for(var i={},t=0,a=e.length;t<a;t++){var s=e[t];for(var n in s)n in i||(i[n]=s[n])}return this.messages=i,i}},_compiledMessageCache:{value:Object.create(null)},localizeSync:{value:function(e,i){var t,a,s;if(!e&&!i)throw new Error("Key or default message must be truthy, not "+e+" and "+i);if(this._messages&&e in this._messages){if(t=this._messages[e],a=typeof t,"function"===a)return t;if("object"===a){if(!("message"in t))throw new Error(t,"does not contain a 'message' property");t=t.message}}else t=i;if(t||(console.warn("No message or default message for key '"+e+"'"),t=e),t in this._compiledMessageCache)return this._compiledMessageCache[t];var n=this.messageFormat.parse(t);return n.program&&n.program.statements&&1===n.program.statements.length&&"string"===n.program.statements[0].type?(s=function(){return t},s.toString=s):s=new Function("MessageFormat","return "+this.messageFormat.precompile(n))(MessageFormat),this._compiledMessageCache[t]=s,s}},localize:{value:function(e,i,t,a){t="undefined"==typeof t||t;var s,n=this;if(this._isInitialized)if(this.messagesPromise){var o=function(){var t=n.localizeSync(e,i);return"function"==typeof a&&a(t),t};s=t?this.messagesPromise.then(o,o):this.messagesPromise.then(o)}else s=Promise.resolve(this.localizeSync(e,i)),s.then(a);else this.initWithLocale(),s=this.messagesPromise.then(function(){return n.localize(e,i,t,a)});return s}},reset:{value:function(){return this.storesLocale&&"undefined"!=typeof window&&window.localStorage&&window.localStorage.removeItem(LOCALE_STORAGE_KEY),this.initWithLocale(),this._locale}},_dispatchLocaleChangeAsNeeded:{value:function(e,i){return!(!i||null!==i.localizer&&void 0!==i.localizer&&i.localizer!==this)&&("function"==typeof i.localizerDidChangeLocale&&i.localizerDidChangeLocale(this,e,this._locale),!0)}},_dispatchLocaleChange:{value:function(e,i){if(i||(i=this.component||rootComponent,this._dispatchLocaleChangeAsNeeded(e,i))){var t=i._childComponents;if(t)for(var a,s=0;s<t.length;s++)a=t[s],this._dispatchLocaleChangeAsNeeded(e,a)&&a._childComponents&&this._dispatchLocaleChange(e,a)}}}},{defaultLocalizer:{value:function(){return defaultLocalizer||(defaultLocalizer=new Localizer,defaultLocalizer.storesLocale=!0),defaultLocalizer}},defaultLocalizerWithDelegate:{value:function(e){return this.defaultLocalizer(),defaultLocalizer.delegate=e,defaultLocalizer}},defaultLocale:{value:"en"}}),defaultLocalizer;Object.defineProperty(exports,"defaultLocalizer",{get:function(){return Localizer.defaultLocalizer()}});var _localize;Object.defineProperty(exports,"localize",{get:function(){if(!_localize){var e=Localizer.defaultLocalizer();_localize=e.bind(e)}return _localize}});var Message=exports.Message=Montage.specialize({constructor:{value:function(){this.addPathChangeListener("localizer.locale",this,"handleLocaleChange")}},init:{value:function(e,i,t){return e&&(this.key=e),i&&(this.defaultMessage=i),t&&(this.data=t),this}},_localizer:{value:null},localizer:{get:function(){return this._localizer||(this._localizer=Localizer.defaultLocalizer()),this._localizer},set:function(e){this._localizer!=e&&(this._localizer=e,this._localize())}},_key:{value:null},key:{get:function(){return this._key},set:function(e){this._key!==e&&(this._key=e,this._localize())}},_defaultMessage:{value:null},defaultMessage:{get:function(){return this._defaultMessage},set:function(e){this._defaultMessage!==e&&(this._defaultMessage=e,this._localize())}},handleLocaleChange:{value:function(){this._key&&this._localizer&&this._localizer.isInitialized&&this._localize()}},_isLocalizeQueued:{value:!1},_localize:{value:function(){if(!this._isLocalizeQueued){this._isLocalizeQueued=!0;var e=this;this._messageFunction=new Promise(function(i,t){setTimeout(function(){return e._isLocalizeQueued=!1,e._key||e._defaultMessage?void i(e._localizer.localize(e._key,e._defaultMessage)):void i(EMPTY_STRING_FUNCTION)},0)}),this.localized=this._messageFunction.then(function(i){return e._optimizedMessageCallBack(i)})}}},__messageFunction:{value:null},_messageFunction:{set:function(e){this.__messageFunction=e},get:function(){return this.__messageFunction||(this.__messageFunction=Promise.resolve(EMPTY_STRING_FUNCTION)),this.__messageFunction}},_data:{value:null},data:{get:function(){return this._data||(this._data=new Map,this._data.addMapChangeListener(this,"data")),this._data},set:function(e){if(this._data!==e&&e){this._data?(this.data.removeMapChangeListener(this,"data"),this._data.length&&this._data.clear()):this._data=new Map;for(var i in e)this.data.set(i,e[i]);this._data.addMapChangeListener(this,"data"),this.handleDataMapChange()}}},__localizedResolved:{value:""},_localizedDeferred:{value:Promise.resolve()},localized:{get:function(){return this._localize(),this._localizedDeferred},set:function(e){if(e!==this._localized){var i=this;this._localizedDeferred&&(e=Promise.resolve(e)),e.then(function(e){return i.__localizedResolved=e}),this._localizedDeferred=e}}},handleDataMapChange:{value:function(e){if(this._key){var i=this;this.localized=this._messageFunction.then(function(e){return i._optimizedMessageCallBack(e)})}}},_optimizedMessageCallBack:{value:function(e){return this._data?e(this.data.toObject()):e()}},serializeSelf:{value:function(e){var i={_bindingDescriptors:this._bindingDescriptors};return i.key=this._key,i.defaultMessage=this._defaultMessage,this._localizer!==Localizer.defaultLocalizer()&&(i.localizer=this._localizer),i}},serializeForLocalizations:{value:function(e){var i,t,a={};t=FrbBindings.getBindings(this),t&&t.get("key")?(a[KEY_KEY]={},this._serializeBinding(this,a[KEY_KEY],t.get("key"),e)):a[KEY_KEY]=this._key,t&&t.defaultMessage?(a[DEFAULT_MESSAGE_KEY]={},this._serializeBinding(this,a[DEFAULT_MESSAGE_KEY],t.defaultMessage,e)):a[DEFAULT_MESSAGE_KEY]=this._defaultMessage;var s=FrbBindings.getBindings(this.data);i=this.data.toObject();for(var n in i)!i.hasOwnProperty(n)||s&&s[".get('"+n+"')"]||(a.data||(a.data={}),a.data[n]=i[n]);for(var o,r=s.keys();b=r.next().value;)o=/\.get\('([^']+)'\)/.exec(b)[1],a.data||(a.data={}),a.data[o]={},this._serializeBinding(this.data,a.data[o],s.get(b),e);return a}},_serializeBinding:{value:function(e,i,t,a){if(!("serializable"in t)||t.serializable){var s=t.sourceSyntax;if(t.source!==e){var n=a.addObjectReference(t.source),o=new Scope({type:"component",label:n["@"]});o.components=a,s=expand(s,o)}var o=new Scope;o.components=a;var r=stringify(s,o);t.twoWay?i["<->"]=r:i["<-"]=r,t.converter?i.converter=t.converter:(i.convert=t.convert,i.revert=t.revert),t.trace&&(i.trace=!0)}}}}),createMessageBinding=function(e,i,t,a,s,n){var o=new Message;if(s){var r,l,c,u=o._data=new Map;for(r in s)l=s[r],c=typeof l,"string"===c?u.set(r,l):"object"===c&&Bindings.defineBinding(u,".get('"+r+"')",l,{components:n});u.addMapChangeListener(o,"data")}"object"==typeof t?Bindings.defineBinding(o,"key",t,{components:n}):o.key=t,"object"==typeof a?Bindings.defineBinding(o,"defaultMessage",a,{components:n}):"string"==typeof a&&(o.defaultMessage=a),Bindings.defineBinding(e,i,{"<-":"__localizedResolved",source:o,serializable:!1})};Serializer.defineSerializationUnit("localizations",function(e,i){var t=FrbBindings.getBindings(i);if(t){var a;for(var s in t){var n=t[s];if(Message.prototype.isPrototypeOf(n.source)){a||(a={});var o=n.source;a[s]=o.serializeForLocalizations(e)}}return a}}),Deserializer.defineDeserializationUnit("localizations",function(e,i,t){for(var a in t){var s,n,o=t[a];KEY_KEY in o?(!logger.isDebug||DEFAULT_MESSAGE_KEY in o||logger.debug(this,"Warning: localized property '"+a+"' does not contain a default message property ("+DEFAULT_MESSAGE_KEY+"), in ",i),s=o[KEY_KEY],n=o[DEFAULT_MESSAGE_KEY],createMessageBinding(i,a,s,n,o.data,e)):console.error("localized property '"+a+"' must contain a key property ("+KEY_KEY+"), in ",t[a])}});