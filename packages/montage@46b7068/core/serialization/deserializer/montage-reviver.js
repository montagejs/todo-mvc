var Montage=require("../../core").Montage,PropertiesDeserializer=require("./properties-deserializer").PropertiesDeserializer,SelfDeserializer=require("./self-deserializer").SelfDeserializer,UnitDeserializer=require("./unit-deserializer").UnitDeserializer,ModuleReference=require("../../module-reference").ModuleReference,Alias=require("../alias").Alias,Promise=require("../../promise").Promise,ModuleLoader=Montage.specialize({_require:{value:null},_objectRequires:{value:null},init:{value:function(e,t){if("function"!=typeof e)throw new Error("Function 'require' missing.");if("string"!=typeof e.location)throw new Error("Function 'require' location is missing");if("object"!=typeof t&&"undefined"!=typeof t)throw new Error("Parameter 'objectRequires' should be an object.");return this._require=e,this._objectRequires=t,this}},getExports:{value:function(e,t){var r;for(t=e.resolve(t),r=e.getModuleDescriptor(t);void 0!==r.redirect;)r=e.getModuleDescriptor(r.redirect);return void 0!==r.mappingRedirect?this.getExports(r.mappingRequire,r.mappingRedirect):r.exports}},getModule:{value:function(e,t){var r,i,n=this._objectRequires;return r=n&&t in n?n[t]:this._require,i=this.getExports(r,e),i||(i=r.async(e)),i}}}),MontageReviver=exports.MontageReviver=Montage.specialize({moduleLoader:{value:null},init:{value:function(e,t){return this.moduleLoader=(new ModuleLoader).init(e,t),this._require=e,this}},getTypeOf:{value:function(e){var t=typeof e;if(null===e)return"null";if(Array.isArray(e))return"array";if("object"===t&&1===Object.keys(e).length){if("@"in e)return"reference";if("/"in e)return"regexp";if("#"in e)return"Element";if("%"in e)return"Module"}return t}},_checkLabel:{value:function(e,t){return t&&":"!==e[0]?new Error('Aliases can only be defined in template properties (start with a colon (:)), "'+e+'".'):t||":"!==e[0]?void 0:new Error('Only aliases are allowed as template properties (start with a colon (:), "'+e+'".')}},reviveRootObject:{value:function(e,t,r){var i,n="alias"in e;if(i=this._checkLabel(r,n))return Promise.reject(i);var o;if(e["debugger"]&&console.log("enable debugger statement here"),"value"in e){if(t.hasUserObject(r))return o=t.getUserObject(r),t.setObjectLabel(o,r),o;var a;if("Element"===this.getTypeOf(e.value)){if(a=this.reviveElement(e.value,t,r),!Promise.is(a)){var s=this.reviveObjectLiteral(e,t);t.setUnitsToDeserialize(a,s,MontageReviver._unitNames)}}else a=this.reviveValue(e.value,t,r);return a}return 0===Object.keys(e).length?t.hasUserObject(r)?(o=t.getUserObject(r),t.setObjectLabel(o,r),o):this.reviveExternalObject(e,t,r):this.reviveCustomObject(e,t,r)}},reviveElement:{value:function(e,t,r){var i=e["#"],n=t.getElementById(i);return n?(r&&t.setObjectLabel(n,r),n):Promise.reject(new Error("Element with id '"+i+"' was not found."))}},reviveModule:{value:function(e,t,r){var i=e["%"],n=t.getRequire();i=n.resolve(i);var o=n.getModuleDescriptor(i);return(new ModuleReference).initWithIdAndRequire(o.id,o.require)}},reviveCustomObject:{value:function(e,t,r){return"alias"in e?this.reviveAlias(e,t,r):this.reviveMontageObject(e,t,r)}},reviveMontageObject:{value:function(e,t,r){var i,n,o,a=this,s=e.prototype||e.object;return s&&(n=MontageReviver.parseObjectLocationId(s),i=this.moduleLoader.getModule(n.moduleId,r),o=n.objectName),Promise.is(i)?i.then(function(i){return"object"in e&&e.object.endsWith(".mjson")?a.instantiateMjsonObject(i,n.moduleId):a.instantiateMontageObject(e,i,o,t,r)},function(t){throw t.stack&&console.error(t.stack),new Error('Error deserializing "'+r+'" when loading module "'+n.moduleId+"' from '"+e.prototype+"' cause: "+t.message)}):"object"in e&&e.object.endsWith(".mjson")?a.instantiateMjsonObject(i,n.moduleId):this.instantiateMontageObject(e,i,o,t,r)}},instantiateMjsonObject:{value:function(e,t){var r=this,i=function(e,t){for(var r=e.resolve(t),i=e.getModuleDescriptor(r);i.redirect||i.mappingRedirect;)i.redirect?r=i.redirect:(e=i.mappingRequire,r=i.mappingRedirect),i=e.getModuleDescriptor(r);return i.require};return require.async("core/serialization/deserializer/montage-deserializer").then(function(n){return(new n.MontageDeserializer).init(JSON.stringify(e),i(r._require,t)).deserializeObject()})}},instantiateMontageObject:{value:function(e,t,r,i,n){var o,a,s=this;return o=this.getMontageObject(e,t,r,i,n),i.setObjectLabel(o,n),null!==o&&void 0!==o&&(o.isDeserializing=!0),a=this.reviveObjectLiteral(e,i),Promise.is(a)?a.then(function(e){return s.deserializeMontageObject(e,o,i,n)}):this.deserializeMontageObject(a,o,i,n)}},deserializeMontageObject:{value:function(e,t,r,i){var n;return"function"==typeof t.deserializeSelf?this.deserializeCustomMontageObject(t,e,r,i):(r.setUnitsToDeserialize(t,e,MontageReviver._unitNames),n=this.deserializeMontageObjectProperties(t,e.properties,r),Promise.is(n)?n.then(function(){return t}):t)}},deserializeMontageObjectProperties:{value:function(e,t,r){var i;if("function"==typeof e.deserializeProperties){var n=(new PropertiesDeserializer).initWithReviverAndObjects(this,r);i=e.deserializeProperties(n)}else for(var o in t)e[o]=t[o];return i}},deserializeCustomMontageObject:{value:function(e,t,r,i){var n,o=(new SelfDeserializer).initWithObjectAndObjectDescriptorAndContextAndUnitNames(e,t,r,MontageReviver._unitNames);return n=e.deserializeSelf(o),Promise.is(n)?n.then(function(e){return r.setObjectLabel(e,i),e}):"undefined"!=typeof n?(r.setObjectLabel(n,i),n):e}},getMontageObject:{value:function(e,t,r,i,n){var o;if(i.hasUserObject(n))return i.getUserObject(n);if("prototype"in e){if(!(r in t))throw new Error('Error deserializing "'+n+'": object named "'+r+'" was not found in "'+e.prototype+'". Available objects are: '+Object.keys(t)+".");return o=Object.create(t[r].prototype),o.isDeserializing=!0,"function"==typeof o.didCreate?o.didCreate():"function"==typeof o.constructor&&o.constructor(),o}if("object"in e){if(e.object.endsWith(".json"))return t;if(!(r in t))throw new Error('Error deserializing "'+n+'": object named "'+o+"' was not found given '"+e.object+"'");return t[r]}throw new Error("Error deserializing "+JSON.stringify(e)+', might need "prototype" or "object" on label '+JSON.stringify(n))}},reviveAlias:{value:function(e,t,r){var i=new Alias;return i.value=e.alias,t.setObjectLabel(i,r),i}},didReviveObjects:{value:function(e,t){var r,i=this;return r=this._deserializeUnits(t),Promise.is(r)?r.then(function(){i._invokeDeserializedFromSerialization(e,t)}):void this._invokeDeserializedFromSerialization(e,t)}},_invokeDeserializedFromSerialization:{value:function(e,t){var r;for(var i in e)r=e[i],null!==r&&void 0!==r&&delete r.isDeserializing,t.hasUserObject(i)||r&&"function"==typeof r.deserializedFromSerialization&&r.deserializedFromSerialization(i)}},_deserializeUnits:{value:function(e){var t,r,i=e.getUnitsToDeserialize(),n=MontageReviver._unitRevivers;try{for(var o,a=0;o=i[a];a++){t=o.unitNames;for(var s,u=0;s=t[u];u++)s in o.objectDesc&&(r=(new UnitDeserializer).initWithContext(e),n[s](r,o.object,o.objectDesc[s]))}}catch(l){return Promise.reject(l)}}},_createAssignValueFunction:{value:function(e,t){return function(r){e[t]=r}}},getCustomObjectTypeOf:{writable:!0,value:function(){}},reviveValue:{value:function(e,t,r){var i=this.getTypeOf(e);return"string"===i||"number"===i||"boolean"===i||"null"===i||"undefined"===i?this.reviveNativeValue(e,t,r):"regexp"===i?this.reviveRegExp(e,t,r):"reference"===i?this.reviveObjectReference(e,t,r):"array"===i?this.reviveArray(e,t,r):"object"===i?this.reviveObjectLiteral(e,t,r):"Element"===i?this.reviveElement(e,t,r):this._callReviveMethod("revive"+i,e,t,r)}},reviveNativeValue:{value:function(e,t,r){return r&&t.setObjectLabel(e,r),e}},reviveObjectLiteral:{value:function(e,t,r){var i,n=[];r&&t.setObjectLabel(e,r);for(var o in e)i=this.reviveValue(e[o],t),Promise.is(i)?n.push(i.then(this._createAssignValueFunction(e,o))):e[o]=i;return 0===n.length?e:Promise.all(n).then(function(){return e})}},reviveRegExp:{value:function(e,t,r){var e=e["/"],i=new RegExp(e.source,e.flags);return r&&t.setObjectLabel(i,r),i}},reviveObjectReference:{value:function(e,t,r){var e=e["@"],i=t.getObject(e);return i}},reviveArray:{value:function(e,t,r){var i,n=[];r&&t.setObjectLabel(e,r);for(var o=0,a=e.length;o<a;o++)i=this.reviveValue(e[o],t),Promise.is(i)?n.push(i.then(this._createAssignValueFunction(e,o))):e[o]=i;return 0===n.length?e:Promise.all(n).then(function(){return e})}},reviveExternalObject:{value:function(e,t,r){return Promise.reject(new Error("External object '"+r+"' not found in user objects."))}},_callReviveMethod:{value:function(e,t,r,i){return this[e](t,r,i)}}},{_unitRevivers:{value:Object.create(null)},_unitNames:{value:[]},_findObjectNameRegExp:{value:/([^\/]+?)(\.reel)?$/},_toCamelCaseRegExp:{value:/(?:^|-)([^-])/g},_replaceToCamelCase:{value:function(e,t){return t.toUpperCase()}},_locationDescCache:{value:Object.create(null)},customObjectRevivers:{value:Object.create(null)},parseObjectLocationId:{value:function(e){var t,r,i,n,o=this._locationDescCache;return e in o?t=o[e]:(r=e.indexOf("["),r>0?(i=e.substr(0,r),n=e.slice(r+1,-1)):(i=e,this._findObjectNameRegExp.test(e),n=RegExp.$1.replace(this._toCamelCaseRegExp,this._replaceToCamelCase)),t={moduleId:i,objectName:n},o[e]=t),t}},defineUnitReviver:{value:function(e,t){this._unitRevivers[e]=t,this._unitNames.push(e)}},getTypeOf:{value:function(e){return this.prototype.getTypeOf.call(this,e)}},addCustomObjectReviver:{value:function(e){var t=this.customObjectRevivers;for(var r in e)if("getTypeOf"!==r&&"function"==typeof e[r]&&/^revive/.test(r)){if("undefined"!=typeof t[r])return new Error("Reviver '"+r+"' is already registered.");t[r]=e[r].bind(e)}this.prototype.getCustomObjectTypeOf=this.makeGetCustomObjectTypeOf(e.getTypeOf)}},resetCustomObjectRevivers:{value:function(){this.customObjectRevivers=Object.create(null),this.prototype.getCustomObjectTypeOf=function(){}}},makeGetCustomObjectTypeOf:{value:function(e){var t=this.prototype.getCustomObjectTypeOf;return function(r){return e(r)||t(r)}}}});"undefined"!=typeof exports&&(exports.MontageReviver=MontageReviver);