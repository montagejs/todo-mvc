var Montage=require("../../core").Montage,MontageReviver=require("./montage-reviver").MontageReviver,parse=require("frb/parse"),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(i){this._serialization=i}},extractObjects:{value:function(i,e){var a=this._serialization,n={};e=e||[];for(var t,l=0;t=i[l];l++)t in a&&(n[t]=a[t],this._findLabels(t,e));for(var t,l=0;t=e[l];l++)!(t in n)&&t in a&&(n[t]={});return JSON.parse(JSON.stringify(n))}},_findLabels:{value:function(i,e){var a;if(e.indexOf(i)===-1){if(!(i in this._serialization))throw new Error("Object '"+i+"' not found.");e.push(i),a=this._serialization[i],this._collectLabels(a,e),this._collectLabelsInUnits(a,e)}}},_collectLabels:{value:function(i,e){var a,n=MontageReviver.getTypeOf(i);if("reference"===n)a=i["@"],this._findLabels(a,e);else if("array"===n)for(var t=0,l=i.length;t<l;t++)this._collectLabels(i[t],e);else if("object"===n)for(var o in i)this._collectLabels(i[o],e)}},_collectLabelsInUnits:{value:function(i,e){"bindings"in i?this._collectLabelsInBindings(i.bindings,e):"localizations"in i&&this._collectLabelsInLocalizations(i.localizations,e)}},_collectLabelsInBindings:{value:function(i,e){var a,n;for(var t in i)a=i[t],n=a["<-"]||a["<->"],this._collectLabelsInBindingPath(n,e)}},_collectLabelsInBindingPath:{value:function(i,e){var a=this,n=parse(i);this._traverseBindingParseTree(n,function(i){a._findLabels(i.label,e)})}},_traverseBindingParseTree:{value:function(i,e){var a=i.args;if("component"===i.type&&e(i),a)for(var n=0,t=a.length;n<t;n++)this._traverseBindingParseTree(a[n],e)}},_collectLabelsInLocalizations:{value:function(i,e){for(var a in i)this._collectLabelsInLocalizationProperty(i[a],e)}},_collectLabelsInLocalizationProperty:{value:function(i,e){var a;if("key"in i&&this._collectLabelsInLocalizationBinding(i.key,e),"default"in i&&this._collectLabelsInLocalizationBinding(i["default"],e),"data"in i){a=i.data;for(var n in a)this._collectLabelsInLocalizationBinding(a[n],e)}}},_collectLabelsInLocalizationBinding:{value:function(i,e){var a=i["<-"]||i["<->"];a&&this._collectLabelsInBindingPath(a,e)}}});exports.SerializationExtractor=SerializationExtractor;