var Montage=require("../../core").Montage,MontageInterpreter=require("./montage-interpreter").MontageInterpreter,MontageReviver=require("./montage-reviver").MontageReviver,deprecate=require("../../deprecate"),MontageDeserializer=exports.MontageDeserializer=Montage.specialize({_interpreter:{value:null},_serializationString:{value:null},_serialization:{value:null},serialization:{value:{get:function(){return this._serialization}}},init:{value:function(e,i,t){return this._serializationString=e,this._interpreter=(new MontageInterpreter).init(i,t),this}},initWithObject:{value:function(e,i,t){return this._serializationString=JSON.stringify(e),this._interpreter=(new MontageInterpreter).init(i,t),this}},initWithObjectAndRequire:{value:deprecate.deprecateMethod(void 0,function(e,i,t){return this.initWithObject(e,i,t)},"initWithObjectAndRequire","initWithObject")},deserialize:{value:function(e,i){try{var t=JSON.parse(this._serializationString)}catch(r){return this._formatSerializationSyntaxError(this._serializationString)}return this._interpreter.instantiate(t,e,i)}},deserializeObject:{value:function(e){return this.deserialize(e).then(function(e){return e.root})}},preloadModules:{value:function(){var e=JSON.parse(this._serializationString);return this._interpreter.preloadModules(e)}},getExternalObjectLabels:{value:function(){var e=this._serialization,i=[];for(var t in e)0===Object.keys(e[t]).length&&i.push(t);return i}},_formatSerializationSyntaxError:{value:function(e){var i,t,r,n,a,o="   ",l=this._origin;return require.async("jslint/lib/jslint").then(function(s){if(s.JSHINT(e))i="Syntax error in the serialization but not able to find it!\n"+e;else{t=s.JSHINT.errors[0],r=e.split("\n"),n=(o+r.length).length,a=t.line-1;for(var u=0,h=r.length;u<h;u++)r[u]=new Array(n-(u+1+"").length+1).join(u===a?">":" ")+(u+1)+" "+r[u];i="Syntax error at line "+t.line+(l?" from "+l:"")+":\n"+t.evidence+"\n"+t.reason+"\n"+r.join("\n")}throw new Error(i)})}}});MontageDeserializer.defineDeserializationUnit=function(e,i){MontageReviver.defineUnitReviver(e,i)},exports.deserialize=function(e,i){return(new MontageDeserializer).init(e,i).deserializeObject()};