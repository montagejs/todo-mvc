var Montage=require("../../core").Montage,MontageSerializerModule=require("./montage-serializer"),PropertiesSerializer=require("./properties-serializer").PropertiesSerializer,SelfSerializer=require("./self-serializer").SelfSerializer,UnitSerializer=require("./unit-serializer").UnitSerializer,Alias=require("../alias").Alias,MontageVisitor=Montage.specialize({_MONTAGE_ID_ATTRIBUTE:{value:"data-montage-id"},_require:{value:null},_units:{value:null},_elements:{value:null},builder:{value:null},labeler:{value:null},_objectsSerialization:{value:null},initWithBuilderAndLabelerAndRequireAndUnits:{value:function(e,t,i,r){return this.builder=e,this.labeler=t,this._objectsSerialization=Object.create(null),this._require=i,this._units=r,this._elements=[],this}},getTypeOf:{value:function(e){return e.isModuleReference?"Module":e instanceof Alias?"Alias":"getInfoForObject"in e||"getInfoForObject"in e.constructor?"MontageObject":e.thisIsAReferenceCreatedByMontageSerializer?"MontageReference":"undefined"!=typeof Element&&Element.isElement(e)?"Element":void 0}},visitMontageReference:{value:function(e,t,i){this.builder.top.setProperty(i,t.reference)}},visitElement:{value:function(e,t,i){var r,s;if(s=t.getAttribute(this._MONTAGE_ID_ATTRIBUTE),!s)throw new Error("Not possible to serialize a DOM element with no "+this._MONTAGE_ID_ATTRIBUTE+" assigned: "+t.outerHTML);r=this.builder.createElementReference(s),this.storeValue(r,t,i),this._elements.push(t)}},visitModule:{value:function(e,t,i){var r,s;try{s=t.resolve(this._require)}catch(l){throw new Error("Not possible to serialize module reference "+t.id+" from package "+t.require.location+" inside package "+this._require.location)}r=this.builder.createModuleReference(s),this.storeValue(r,t,i)}},visitAlias:{value:function(e,t){var i=this.labeler.getTemplatePropertyLabel(t),r=this.builder.createCustomObject();r.setProperty("alias",t.value),this.builder.top.setProperty(i,r)}},visitMontageObject:{value:function(e,t,i){this.isObjectSerialized(t)?this.serializeReferenceToMontageObject(e,t,i):this.handleMontageObject(e,t,i)}},handleMontageObject:{value:function(e,t,i){var r,s=this.builder.createCustomObject();this.setObjectSerialization(t,s),r=this.serializeMontageObject(e,t,s),r?this.serializeSubstituteObject(e,t,i,s,r):(s.setLabel(this.labeler.getObjectLabel(t)),this.builder.top.setProperty(i,s))}},serializeReferenceToMontageObject:{value:function(e,t,i){var r=this.labeler.getObjectLabel(t),s=this.builder.createObjectReference(r);this.builder.top.setProperty(i,s)}},serializeSubstituteObject:{value:function(e,t,i,r,s){var l,a,n,o;l=this.labeler.getObjectLabel(t),this.labeler.isUserDefinedLabel(l)?(a=this.labeler.getObjectLabel(s),this.labeler.setObjectLabel(s,l),this.builder.relabelReferences(a,l),o=this.getObjectSerialization(s),o&&(o.setLabel(l),this.labeler.isUserDefinedLabel(a)&&this.builder.createObjectReference(l).setLabel(a)),e.visit(s,i)):(e.visit(s,i),n=this.labeler.getObjectLabel(s),this.labeler.setObjectLabel(t,n),this.builder.relabelReferences(l,n))}},serializeMontageObject:{value:function(e,t,i){var r,s,l=this.builder.createObjectLiteral();return this.setObjectType(t,i),i.setProperty("properties",l),this.builder.push(i),"function"==typeof t.serializeSelf?(r=(new SelfSerializer).initWithMalkerAndVisitorAndObject(e,this,t,i),s=t.serializeSelf(r)):(this.setObjectProperties(e,t),this.setObjectCustomUnits(e,t)),this.builder.pop(),0===l.getPropertyNames().length&&i.clearProperty("properties"),s}},setObjectType:{value:function(e,t){var i=Montage.getInfoForObject(e).isInstance,r=this.getObjectLocationId(e),s=this.builder.createString(r);i?t.setProperty("prototype",s):t.setProperty("object",s)}},getObjectModuleId:{value:function(e){var t=Montage.getInfoForObject(e);return this._require.identify(t.moduleId,t.require)}},getObjectLocationId:{value:function(e){var t,i=this.getObjectModuleId(e),r=Montage.getInfoForObject(e),s=r.objectName;return t=MontageSerializerModule.MontageSerializer.getDefaultObjectNameForModuleId(i),t===s?i:i+"["+s+"]"}},setObjectProperties:{value:function(e,t){var i,r;r=this.builder.top.getProperty("properties"),this.builder.push(r),"function"==typeof t.serializeProperties?(i=(new PropertiesSerializer).initWithMalkerAndVisitorAndObject(e,this,t),t.serializeProperties(i)):this.setSerializableObjectProperties(e,t),this.builder.pop()}},setSerializableObjectProperties:{value:function(e,t){for(var i,r,s=Montage.getSerializablePropertyNames(t),l=s.length,a=0;a<l;a++)r=s[a],i=Montage.getPropertyAttribute(t,r,"serializable"),this.setProperty(e,r,t[r],i)}},hackIsReferenceAllowedForValue:{value:function(e){return"object"==typeof e&&null!=e&&!("undefined"!=typeof Element&&Element.isElement(e))}},setProperty:{value:function(e,t,i,r){var s;if("reference"===r&&this.hackIsReferenceAllowedForValue(i)){s=this.labeler.getObjectLabel(i);var l=this.builder.createObjectReference(s);this.builder.top.setProperty(t,l)}else e.visit(i,t)}},setObjectCustomUnits:{value:function(e,t){for(var i in this._units)this.setObjectCustomUnit(e,t,i)}},setObjectCustomUnit:{value:function(e,t,i){var r,s,l=this._units[i];l&&(s=(new UnitSerializer).initWithMalkerAndVisitorAndObject(e,this,t),r=l(s,t),null!=r&&e.visit(r,i))}},getExternalObjects:{value:function(){for(var e,t={},i=this.builder.getExternalReferences(),r=0;e=i[r];r++)t[e]=this.labeler.getObjectByLabel(e);return t}},getExternalElements:{value:function(){return this._elements}},getCustomObjectTypeOf:{value:function(){},writable:!0},isCustomObject:{value:function(e){var t=this.getCustomObjectTypeOf(e);return"string"==typeof t}},setObjectSerialization:{value:function(e,t){this._objectsSerialization[Object.hash(e)]=t}},getObjectSerialization:{value:function(e){return this._objectsSerialization[Object.hash(e)]}},isObjectSerialized:{value:function(e){return Object.hash(e)in this._objectsSerialization}},enterObject:{value:function(e,t,i){var r=this.builder.createObjectLiteral();this.setObjectSerialization(t,r),this.builder.push(r)}},exitObject:{value:function(e,t,i){this.storeValue(this.builder.pop(),t,i)}},visitObject:{value:function(e,t,i){var r=this.labeler.getObjectLabel(t),s=this.builder.createObjectReference(r);this.getObjectSerialization(t).setLabel(r),this.builder.top.setProperty(i,s)}},enterArray:{value:function(e,t,i){var r=this.builder.createArray();this.setObjectSerialization(t,r),this.builder.push(r)}},exitArray:{value:function(e,t,i){this.storeValue(this.builder.pop(),t,i)}},visitArray:{value:function(e,t,i){var r=this.labeler.getObjectLabel(t),s=this.builder.createObjectReference(r);this.getObjectSerialization(t).setLabel(r),this.builder.top.setProperty(i,s)}},visitRegExp:{value:function(e,t,i){this.storeValue(this.builder.createRegExp(t),t,i)}},visitString:{value:function(e,t,i){this.storeValue(this.builder.createString(t),t,i)}},visitNumber:{value:function(e,t,i){this.storeValue(this.builder.createNumber(t),t,i)}},visitBoolean:{value:function(e,t,i){this.storeValue(this.builder.createBoolean(t),t,i)}},visitNull:{value:function(e,t){this.storeValue(this.builder.createNull(),null,t)}},visitCustomObject:{value:function(e,t,i){var r=this.getCustomObjectTypeOf(t),s=MontageVisitor.customObjectVisitors["visit"+r];if(r)return s.call(global,e,this,t,i);throw new Error("Object's type is unknown: "+t)}},storeValue:{value:function(e,t,i){"undefined"==typeof i?e.setLabel(this.labeler.getObjectLabel(t)):this.builder.top.setProperty(i,e)}}},{customObjectVisitors:{value:Object.create(null)},makeGetCustomObjectTypeOf:{value:function(e){var t=this.prototype.getCustomObjectTypeOf;return function(i){return e(i)||t(i)}}},addCustomObjectVisitor:{value:function(e){var t=this.customObjectVisitors;for(var i in e)if("getTypeOf"!==i&&"function"==typeof e[i]&&/^visit/.test(i)){if("undefined"!=typeof t[i])return new Error("Visitor '"+i+"' is already registered.");t[i]=e[i].bind(e)}this.prototype.getCustomObjectTypeOf=this.makeGetCustomObjectTypeOf(e.getTypeOf)}},resetCustomObjectVisitors:{value:function(){this.customObjectVisitors=Object.create(null),this.prototype.getCustomObjectTypeOf=function(){}}}});exports.MontageVisitor=MontageVisitor;