var Montage=require("../core").Montage,DerivedDescriptor=require("./derived-descriptor").DerivedDescriptor,EventDescriptor=require("./event-descriptor").EventDescriptor,ModelModule=require("./model"),ObjectDescriptorReference=require("./object-descriptor-reference").ObjectDescriptorReference,Promise=require("../promise").Promise,PropertyDescriptor=require("./property-descriptor").PropertyDescriptor,PropertyValidationRule=require("./validation-rule").PropertyValidationRule,deprecate=require("../deprecate"),Defaults={name:"default",customPrototype:!1},ObjectDescriptor=exports.ObjectDescriptor=Montage.specialize({FileExtension:{value:".mjson"},constructor:{value:function(){this._eventDescriptors=[],this._propertyDescriptors=[],this._propertyDescriptorGroups={},Object.defineProperty(this,"_propertyDescriptorsTable",{value:{},writable:!1}),Object.defineProperty(this,"_eventPropertyDescriptorsTable",{value:{},writable:!1}),this.defineBinding("eventDescriptors",{"<-":"_eventDescriptors.concat(parent.eventDescriptors)"})}},initWithName:{value:function(e){return this._name=null!==e?e:"default",this.customPrototype=!1,this}},serializeSelf:{value:function(e){e.setProperty("name",this.name),this._model&&!this.model.isDefault&&e.setProperty("model",this._model,"reference"),this.objectDescriptorInstanceModule&&e.setProperty("objectDescriptorModule",this.objectDescriptorInstanceModule),this._parentReference&&e.setProperty("parent",this._parentReference),this._setPropertyWithDefaults(e,"customPrototype",this.customPrototype),this._propertyDescriptors.length>0&&e.setProperty("propertyDescriptors",this._propertyDescriptors),Object.getOwnPropertyNames(this._propertyDescriptorGroups).length>0&&e.setProperty("propertyDescriptorGroups",this._propertyDescriptorGroups),this._eventDescriptors.length>0&&e.setProperty("eventDescriptors",this._eventDescriptors),this._propertyValidationRules.length>0&&e.setProperty("propertyValidationRules",this._propertyValidationRules),"number"==typeof this.maxAge&&e.setProperty("maxAge",this.maxAge)}},deserializeSelf:{value:function(e){var r;this._name=e.getProperty("name"),r=e.getProperty("model")||e.getProperty("binder"),r&&(this._model=r),this.objectDescriptorInstanceModule=e.getProperty("objectDescriptorModule")||e.getProperty("blueprintModule"),this._parentReference=e.getProperty("parent"),this.customPrototype=this._getPropertyWithDefaults(e,"customPrototype"),r=e.getProperty("propertyDescriptors")||e.getProperty("propertyBlueprints"),r&&(this._propertyDescriptors=r),r=e.getProperty("propertyDescriptorGroups")||e.getProperty("propertyBlueprintGroups"),r&&(this._propertyDescriptorGroups=r),r=e.getProperty("eventDescriptors")||e.getProperty("eventBlueprints"),r&&(this._eventDescriptors=r),r=e.getProperty("propertyValidationRules"),r&&(this._propertyValidationRules=r),r=e.getProperty("maxAge"),r&&(this.maxAge=r)}},_setPropertyWithDefaults:{value:function(e,r,t){t!=Defaults[r]&&e.setProperty(r,t)}},_getPropertyWithDefaults:{value:function(e,r){var t=e.getProperty(r);return t?t:Defaults[r]}},_name:{value:null},name:{get:function(){return this._name}},create:{value:function(e,r,t){var o;if("undefined"==typeof e||ObjectDescriptor.prototype.isPrototypeOf(e)){var i=Object.getPrototypeOf(ObjectDescriptor).create;return i.call(this,"undefined"==typeof e?this:e,r,t)}return o="function"==typeof e.specialize||r?e.specialize(r,t):new e,this.ObjectProperty.applyWithObjectDescriptor(o.prototype,this),this.customPrototype=!0,o}},newInstance:{value:function(){var e=this.newInstancePrototype();return e?new e:null}},newInstancePrototype:{value:function(){if(!this.customPrototype){var e=this.parent?this.parent.newInstancePrototype():Montage,r=e.specialize({init:{value:function(){return this}}});return this.ObjectProperty.applyWithObjectDescriptor(r.prototype,this),r?r:null}throw new Error("FIXME")}},ObjectProperty:{serializable:!1,enumerable:!0,get:function(){return this.model?this.model.ObjectProperty:ModelModule.Model.group.defaultObjectDescriptorObjectProperty}},objectDescriptorInstanceModule:{serializable:!1,value:null},identifier:{get:function(){return["objectDescriptor",(this.name||"unnamed").toLowerCase()].join("_")}},_model:{value:null},model:{serializable:!1,get:function(){return this._model||(this._model=ModelModule.Model.group.defaultModel,this._model.addObjectDescriptor(this)),this._model},set:function(e){this._model=e}},_parentReference:{value:null},_parent:{value:null},parent:{serializable:!1,get:function(){return this._parent},set:function(e){e?(this._parentReference=(new ObjectDescriptorReference).initWithValue(e),this._parent=e):(this._parentReference=null,this._parent=null)}},customPrototype:{value:!1},_propertyDescriptors:{value:null},propertyDescriptors:{get:function(){var e=[];return e=e.concat(this._propertyDescriptors),this.parent&&(e=e.concat(this.parent.propertyDescriptors)),e}},_propertyDescriptorsTable:{value:null},addPropertyDescriptor:{value:function(e){if(null!==e&&null!==e.name){var r=this._propertyDescriptors.indexOf(e);r<0&&(null!==e.owner&&e.owner!==this&&e.owner.removePropertyDescriptor(e),this._propertyDescriptors.push(e),this._propertyDescriptorsTable[e.name]=e,e._owner=this)}return e}},removePropertyDescriptor:{value:function(e){if(null!==e&&null!==e.name){var r=this._propertyDescriptors.indexOf(e);r>=0&&(this._propertyDescriptors.splice(r,1),delete this._propertyDescriptorsTable[e.name],e._owner=null)}return e}},newPropertyDescriptor:{value:function(e,r){return(new PropertyDescriptor).initWithNameObjectDescriptorAndCardinality(e,this,r)}},addToOnePropertyDescriptorNamed:{value:function(e){return this.addPropertyDescriptor(this.newPropertyDescriptor(e,1))}},addToManyPropertyDescriptorNamed:{value:function(e){return this.addPropertyDescriptor(this.newPropertyDescriptor(e,1/0))}},addToOneAssociationBlueprintNamed:{value:function(e,r){var t=this.addPropertyDescriptor(this.addToOnePropertyDescriptorNamed(e));return r&&(t.valueDescriptor=r.owner,r.valueDescriptor=this),t}},addToManyAssociationBlueprintNamed:{value:function(e,r){var t=this.addPropertyDescriptor(this.addToManyPropertyDescriptorNamed(e));return r&&(t.valueDescriptor=r.owner,r.valueDescriptor=this),t}},propertyDescriptorForName:{value:function(e){var r=this._propertyDescriptorsTable[e];if(void 0===r){r=UnknownPropertyDescriptor;var t,o;for(o=0;"undefined"!=typeof(t=this._propertyDescriptors[o]);o++)if(t.name===e){r=t;break}this._propertyDescriptorsTable[e]=r}return r===UnknownPropertyDescriptor&&(r=null),!r&&this.parent&&(r=this.parent.propertyDescriptorForName(e)),r}},_propertyDescriptorGroups:{value:null},propertyDescriptorGroups:{get:function(){var e,r=[];for(e in this._propertyDescriptorGroups)r.push(e);return this.parent&&(r=r.concat(this.parent.propertyDescriptorGroups)),r}},propertyDescriptorGroupForName:{value:function(e){var r=this._propertyDescriptorGroups[e];return!r&&this.parent&&(r=this.parent.propertyDescriptorGroupForName(e)),r}},addPropertyDescriptorGroupNamed:{value:function(e){var r=this._propertyDescriptorGroups[e];return null==r&&(r=[],this._propertyDescriptorGroups[e]=r),r}},removePropertyDescriptorGroupNamed:{value:function(e){var r=this._propertyDescriptorGroups[e];return null!=r&&delete this._propertyDescriptorGroups[e],r}},addPropertyDescriptorToGroupNamed:{value:function(e,r){var t,o=this._propertyDescriptorGroups[r];return null==o&&(o=this.addPropertyDescriptorGroupNamed(r)),t=o.indexOf(e),t<0&&o.push(e),o}},removePropertyDescriptorFromGroupNamed:{value:function(e,r){var t=this._propertyDescriptorGroups[r];if(null!=t&&null!=e){var o=t.indexOf(e);o>=0&&t.splice(o,1)}return null!=t?t:[]}},_eventDescriptors:{value:null},eventDescriptors:{value:null},_eventPropertyDescriptorsTable:{value:null},addEventDescriptor:{value:function(e){if(null!==e&&null!==e.name){var r=this._eventDescriptors.indexOf(e);r<0&&(e.owner&&e.owner!==this&&e.owner.removeEventDescriptor(e),this._eventDescriptors.push(e),this._eventPropertyDescriptorsTable[e.name]=e,e._owner=this)}return e}},removeEventDescriptor:{value:function(e){if(null!==e&&null!==e.name){var r=this._eventDescriptors.indexOf(e);r>=0&&(this._eventDescriptors.splice(r,1),delete this._eventPropertyDescriptorsTable[e.name],e._owner=null)}return e}},newEventDescriptor:{value:function(e){return(new EventDescriptor).initWithNameAndObjectDescriptor(e,this)}},addEventDescriptorNamed:{value:function(e){return this.addEventDescriptor(this.newEventDescriptor(e))}},eventDescriptorForName:{value:function(e){var r=this._eventPropertyDescriptorsTable[e];if("undefined"==typeof r){r=UnknownEventDescriptor;var t,o;for(o=0;"undefined"!=typeof(t=this._eventDescriptors[o]);o++)if(t.name===e){r=t;break}this._eventPropertyDescriptorsTable[e]=r}return r===UnknownEventDescriptor&&(r=null),!r&&this.parent&&(r=this.parent.eventDescriptorForName(e)),r}},_propertyValidationRules:{value:{}},propertyValidationRules:{get:function(){var e,r=[];for(e in this._propertyValidationRules)r.push(this._propertyValidationRules[e]);return this.parent&&(r=r.concat(this.parent.propertyValidationRules)),r}},propertyValidationRuleForName:{value:function(e){var r=this._propertyValidationRules[e];return!r&&this.parent&&(r=this.parent.propertyValidationRuleForName(e)),r}},addPropertyValidationRule:{value:function(e){var r=this._propertyValidationRules[e];return null==r&&(r=(new PropertyValidationRule).initWithNameAndObjectDescriptor(e,this),this._propertyValidationRules[e]=r),r}},removePropertyValidationRule:{value:function(e){var r=this._propertyValidationRules[e];return null!=r&&delete this._propertyValidationRules[e],r}},evaluateRules:{value:function(e){var r,t,o=[];for(r in this._propertyValidationRules)t=this._propertyValidationRules[r],t.evaluateRule(e)&&o.push(t.messageKey);return o}},objectDescriptorModuleId:require("../core")._objectDescriptorModuleIdDescriptor,objectDescriptor:require("../core")._objectDescriptorDescriptor,addEventBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){return this.addEventDescriptor(e)},"addEventBlueprint","addEventDescriptor")},addEventBlueprintNamed:{value:deprecate.deprecateMethod(void 0,function(e){return this.addEventDescriptorNamed(e)},"addEventBlueprintNamed","addEventDescriptorNamed")},addPropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){this.addPropertyDescriptor(e)},"addPropertyBlueprint","addPropertyDescriptor")},addPropertyBlueprintGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e){this.addPropertyDescriptorGroupNamed(e)},"addPropertyBlueprintGroupNamed","addPropertyDescriptorGroupNamed")},addPropertyBlueprintToGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e,r){this.addPropertyDescriptorToGroupNamed(e,r)},"addPropertyBlueprintToGroupNamed","addPropertyDescriptorToGroupNamed")},addToOnePropertyBlueprintNamed:{value:deprecate.deprecateMethod(void 0,function(e){return this.addToOnePropertyDescriptorNamed(e)},"addToOnePropertyBlueprintNamed","addToOnePropertyDescriptorNamed")},addToManyPropertyBlueprintNamed:{value:deprecate.deprecateMethod(void 0,function(e){return this.addToManyPropertyDescriptorNamed(e)},"addToManyPropertyBlueprintNamed","addToManyPropertyDescriptorNamed")},blueprintInstanceModule:{serializable:!1,get:deprecate.deprecateMethod(void 0,function(){return this.objectDescriptorInstanceModule},"blueprintInstanceModule.get","objectDescriptorInstanceModule.get"),set:deprecate.deprecateMethod(void 0,function(e){this.objectDescriptorInstanceModule=e},"blueprintInstanceModule.set","objectDescriptorInstanceModule.set")},binder:{serializable:!1,get:deprecate.deprecateMethod(void 0,function(){return this.model},"binder.get","model.get"),set:deprecate.deprecateMethod(void 0,function(e){this.model=e},"binder.set","model.set")},eventBlueprintForName:{value:deprecate.deprecateMethod(void 0,function(e){return this.eventDescriptorForName(e)},"eventBlueprintForName","eventDescriptorForName")},eventBlueprints:{get:deprecate.deprecateMethod(void 0,function(){return this.eventDescriptors},"eventBlueprints.get","eventDescriptors.get"),set:deprecate.deprecateMethod(void 0,function(e){this.eventDescriptors=e},"eventBlueprints.set","eventDescriptors.set")},newAssociationBlueprint:{value:function(e,r){return 1===r?this.addToOnePropertyDescriptorNamed(e):this.addToManyPropertyDescriptorNamed(e)}},newDerivedPropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e,r){return this.newDerivedDescriptor(e,r)},"newDerivedPropertyBlueprint","newDerivedDescriptor")},newDerivedDescriptor:{value:function(e,r){return(new DerivedDescriptor).initWithNameObjectDescriptorAndCardinality(e,this,r)}},newEventBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){return this.newEventDescriptor(e)},"newEventBlueprint","newEventDescriptor")},newPropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e,r){return this.newPropertyDescriptor(e,r)},"newPropertyBlueprint","newPropertyDescriptor")},propertyBlueprintForName:{value:deprecate.deprecateMethod(void 0,function(e){return this.propertyDescriptorForName(e)},"propertyBlueprintForName","propertyDescriptorForName")},propertyBlueprintGroups:{get:deprecate.deprecateMethod(void 0,function(){return this.propertyDescriptorGroups},"propertyBlueprintGroups","propertyDescriptorGroups")},propertyBlueprintGroupForName:{value:deprecate.deprecateMethod(void 0,function(e){return this.propertyDescriptorGroupForName(e)},"propertyBlueprintGroupForName","propertyDescriptorForName")},propertyBlueprints:{get:deprecate.deprecateMethod(void 0,function(){return this.propertyDescriptors},"propertyBlueprints","propertyDescriptors")},removeEventBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){this.removeEventDescriptor(e)},"removeEventBlueprint","removeEventDescriptor")},removePropertyBlueprint:{value:deprecate.deprecateMethod(void 0,function(e){this.removePropertyDescriptor(e)},"removePropertyBlueprint","removePropertyDescriptor")},removePropertyBlueprintFromGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e,r){this.removePropertyDescriptorFromGroupNamed(e,r)},"removePropertyBlueprintFromGroupNamed","removePropertyDescriptorGroupNamed")},removePropertyBlueprintGroupNamed:{value:deprecate.deprecateMethod(void 0,function(e){this.removePropertyDescriptorGroupNamed(e)},"removePropertyBlueprintGroupNamed","removePropertyDescriptorGroupNamed")},maxAge:{value:240},blueprintModuleId:require("../core")._objectDescriptorModuleIdDescriptor,blueprint:require("../core")._objectDescriptorDescriptor},{createDefaultBlueprintForObject:{value:deprecate.deprecateMethod(void 0,function(e){return ObjectDescriptor.createDefaultObjectDescriptorForObject(e)},"Blueprint.createDefaultBlueprintForObject","ObjectDescriptor.createDefaultObjectDescriptorForObject")},createDefaultObjectDescriptorForObject:{value:function(e){if(e){var r=Montage.getInfoForObject(e).isInstance?Object.getPrototypeOf(e):e.prototype,t=Montage.getInfoForObject(r),o=new this;for(var i in r)if("_"!==i[0]&&r.hasOwnProperty(i)){var p,n=r[i];p=Array.isArray(n)?o.addToManyPropertyDescriptorNamed(i):o.addToOnePropertyDescriptorNamed(i),o.addPropertyDescriptorGroupNamed(p,t.objectName)}var s=Object.getPrototypeOf(r);return s&&"objectDescriptor"in s?s.objectDescriptor.then(function(e){return o.parent=e,o}):Promise.resolve(o)}return Promise.resolve(UnknownObjectDescriptor)}}}),UnknownObjectDescriptor=Object.freeze((new ObjectDescriptor).initWithName("Unknown")),UnknownPropertyDescriptor=Object.freeze((new PropertyDescriptor).initWithNameObjectDescriptorAndCardinality("Unknown",null,1)),UnknownEventDescriptor=Object.freeze((new EventDescriptor).initWithNameAndObjectDescriptor("Unknown",null));