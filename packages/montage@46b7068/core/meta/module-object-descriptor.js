function getModuleRequire(e,r){for(var t=e.resolve(r),o=e.getModuleDescriptor(t);o.redirect||o.mappingRedirect;)o.redirect?t=o.redirect:(e=o.mappingRequire,t=o.mappingRedirect),o=e.getModuleDescriptor(t);return o.require}var Montage=require("../core").Montage,Promise=require("../promise").Promise,ObjectDescriptor=require("./object-descriptor").ObjectDescriptor,Deserializer=require("../serialization/deserializer/montage-deserializer").MontageDeserializer,ModuleReference=require("../module-reference").ModuleReference,deprecate=require("../deprecate"),OBJECT_DESCRIPTOR_CACHE=Object.create(null),ModuleObjectDescriptor=exports.ModuleObjectDescriptor=ObjectDescriptor.specialize({initWithModuleAndExportName:{value:function(e,r){var t=ObjectDescriptor.prototype.initWithName.call(this,r);return t.module=e,t.exportName=r,t}},serializeSelf:{value:function(e){if(!this.module)throw new Error("Cannot serialize object descriptor without a module reference");if(!this.exportName)throw new Error("Cannot serialize object descriptor without an exportName");this["super"](e),this._setPropertyWithDefaults(e,"module",this.module),this._setPropertyWithDefaults(e,"exportName",this.exportName)}},deserializeSelf:{value:function(e){if(this["super"](e),this.module=e.getProperty("module"),this.exportName=e.getProperty("exportName"),!this.module)throw new Error("Cannot deserialize object descriptor without a module reference");if(!this.exportName)throw new Error("Cannot deserialize object descriptor without an exportName")}},module:{value:null},exportName:{value:null},objectDescriptorInstanceModule:{serializable:!1,value:null}},{getObjectDescriptorWithModuleId:{value:function(e,r){if(e.search(/\.meta$/)===-1&&e.search(/\.mjson$/)===-1)throw new Error(e+" object descriptor module id does not end in '.meta' or '.mjson'");if(!r)throw new Error("Require needed to get object descriptor "+e);var t,o=r.location+"#"+e;return o in OBJECT_DESCRIPTOR_CACHE?OBJECT_DESCRIPTOR_CACHE[o]:OBJECT_DESCRIPTOR_CACHE[o]=r.async(e).then(function(o){return t=getModuleRequire(r,e),(new Deserializer).init(JSON.stringify(o),t).deserializeObject()}).then(function(o){if(!ModuleObjectDescriptor.prototype.isPrototypeOf(o))throw new Error("Object in "+e+" is not a module-object-descriptor");return o.objectDescriptorInstanceModule=(new ModuleReference).initWithIdAndRequire(e,r),o._parentReference?o._parentReference.promise(t).then(function(e){return o._parent=e,o}):o})}},createDefaultObjectDescriptorForObject:{value:function(e){var r=Montage.getInfoForObject(e).isInstance?Object.getPrototypeOf(e):e,t=Montage.getInfoForObject(r);return t.objectName&&t.moduleId?this["super"](e).then(function(e){return e.module=(new ModuleReference).initWithIdAndRequire(t.moduleId,t.require),e.exportName=t.objectName,e}):Promise.reject("Cannot create module-object-descriptor for an object that has no been loaded from a module")}},getBlueprintWithModuleId:{value:deprecate.deprecateMethod(void 0,function(e,r){return ModuleObjectDescriptor.getObjectDescriptorWithModuleId(e,r)},"ModuleBlueprint.getBlueprintWithModuleId","ModuleObjectDescriptor.getObjectDescriptorWithModuleId")},createDefaultBlueprintForObject:{value:deprecate.deprecateMethod(void 0,function(e){return ModuleObjectDescriptor.createDefaultObjectDescriptorForObject(e)},"ModuleBlueprint.createDefaultBlueprintForObject","ModuleObjectDescriptor.createDefaultObjectDescriptorForObject")}});