montageDefine("46b7068","core/event/event-manager",{dependencies:["../core","./mutable-event","../serialization/serializer/montage-serializer","../serialization/deserializer/montage-deserializer","collections/map","collections/weak-map","../environment"],factory:function(e,t,n){function i(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}function r(e,t,n,i,r){var a,o,s,l;for(l=n.keys();a=l.next().value;)o=n.get(a),s=o&&o.get(t),Array.isArray(s)&&s.length>0?s.forEach(function(t){i.push({type:a,listener:e.addObjectReference(t),capture:r})}):s&&i.push({type:a,listener:e.addObjectReference(s),capture:r})}var a,o=e("../core").Montage,s=e("./mutable-event").MutableEvent,l=e("../serialization/serializer/montage-serializer").MontageSerializer,u=e("../serialization/deserializer/montage-deserializer").MontageDeserializer,v=e("collections/map"),d=e("collections/weak-map"),c=e("../environment").currentEnvironment;if("undefined"!=typeof window){"function"!=typeof window.CustomEvent&&(i.prototype=window.Event.prototype,window.CustomEvent=i),"undefined"==typeof window.Touch&&"ontouchstart"in window&&(window.Touch=function(){},function(){var e;document.addEventListener("touchstart",e=function t(e){window.Touch=e.touches[0].constructor,document.nativeRemoveEventListener?document.nativeRemoveEventListener("touchstart",t,!0):document.removeEventListener("touchstart",t,!0),a&&a.isStoringPointerEvents&&(a.isStoringPointerEvents=!1,a.isStoringPointerEvents=!0)},!0)}());var h=(o.specialize({constructor:{value:function(e){return this.data=new Array(32),this.velocity={velocity:(new h).initWithIdentifier(e)},this}},data:{enumerable:!1,writable:!0,value:null},size:{enumerable:!1,writable:!0,value:0},pos:{enumerable:!1,writable:!0,value:0},velocity:{enumerable:!1,writable:!0,value:0}}),o.specialize({constructor:{value:function(e,t,n){return this.clientX=e,this.clientY=t,this.timeStamp=n,this}},clientX:{enumerable:!1,writable:!0,value:null},clientY:{enumerable:!1,writable:!0,value:0},timeStamp:{enumerable:!1,writable:!0,value:0}}),o.specialize({_identifier:{enumerable:!1,writable:!0,value:null},initWithIdentifier:{value:function(e){return this._identifier=e,this}},clearCache:{value:function(){return this._data=this._x=this._y=this._speed=this._angle=null,this}},_data:{enumerable:!1,writable:!0,value:null},_x:{enumerable:!1,writable:!0,value:null},_y:{enumerable:!1,writable:!0,value:null},_speed:{enumerable:!1,writable:!0,value:null},_angle:{enumerable:!1,writable:!0,value:null},x:{get:function(){return null===this._x&&(null===this._data&&(this._data=a._getPointerVelocityData(this._identifier)),this._x=a._calculatePointerVelocity(this._data.time,this._data.x)),this._x},set:function(){}},y:{get:function(){return null===this._y&&(null===this._data&&(this._data=a._getPointerVelocityData(this._identifier)),this._y=a._calculatePointerVelocity(this._data.time,this._data.y)),this._y},set:function(){}},speed:{get:function(){return null===this._speed&&(this._speed=Math.sqrt(this.x*this.x+this.y*this.y)),this._speed},set:function(){}},angle:{get:function(){return null===this._angle&&(this._angle=Math.atan2(this.y,this.x)),this._angle},set:function(){}}}));l.defineSerializationUnit("listeners",function(e,t){var n=a,i=[];if(r(e,t,n._registeredCaptureEventListeners,i,!0),r(e,t,n._registeredBubbleEventListeners,i,!1),i.length>0)return i}),u.defineDeserializationUnit("listeners",function(e,t,n){for(var i,r=0;i=n[r];r++)t.addEventListener(i.type,i.listener,i.capture)});var p=Event.NONE,b=Event.CAPTURING_PHASE,m=Event.AT_TARGET,E=Event.BUBBLING_PHASE,g="function";t.EventManager=o.specialize({constructor:{value:function(){return this._trackingTouchStartList=new v,this._trackingTouchEndList=new v,this._claimedPointers=new v,this._registeredCaptureEventListeners=new v,this._registeredBubbleEventListeners=new v,this._observedTarget_byEventType_=Object.create(null),this._currentDispatchedTargetListeners=new v,this._elementEventHandlerByElement=new d,this.environment=c,this._trackingTouchTimeoutIDs=new v,this}},spliceOne:{value:function(e,t){var n=e.length;if(n){for(;t<n;)e[t]=e[t+1],t++;e.length--}}},eventDefinitions:{value:{abort:{bubbles:!1,cancelable:!1},beforeunload:{bubbles:!1},blur:{bubbles:!1,cancelable:!1},change:{bubbles:!0,cancelable:!1},click:{bubbles:!0,cancelable:!0},close:{bubbles:!1,cancelable:!1},compositionend:{bubbles:!0,cancelable:!1},compositionstart:{bubbles:!0,cancelable:!0},compositionupdate:{bubbles:!0,cancelable:!1},contextmenu:{bubbles:!0,cancelable:!0},copy:{bubbles:!0,cancelable:!0},cut:{bubbles:!0,cancelable:!0},dblclick:{bubbles:!0,cancelable:!1},DOMActivate:{bubbles:!0,cancelable:!0,deprecated:!0},DOMMouseScroll:{bubbles:!0},drag:{bubbles:!0,cancelable:!0},dragend:{bubbles:!0,cancelable:!1},dragenter:{bubbles:!0,cancelable:!0},dragleave:{bubbles:!0,cancelable:!1},dragover:{bubbles:!0,cancelable:!0},dragstart:{bubbles:!0,cancelable:!0},drop:{bubbles:!0,cancelable:!0},error:{bubbles:function(e){return!(XMLHttpRequest.prototype.isPrototypeOf(e)||e.tagName&&"VIDEO"===e.tagName.toUpperCase()||e.tagName&&"AUDIO"===e.tagName.toUpperCase())},cancelable:!1},focus:{bubbles:!1,cancelable:!1},focusin:{bubbles:!0,cancelable:!1},focusout:{bubbles:!0,cancelable:!1},input:{bubbles:!0,cancelable:!1},keydown:{bubbles:!0,cancelable:!1},keypress:{bubbles:!0,cancelable:!1},keyup:{bubbles:!0,cancelable:!1},load:{bubbles:!1,cancelable:!1},loadend:{bubbles:!1,cancelable:!1},loadstart:{bubbles:!1,cancelable:!1},message:{bubbles:!1,cancelable:!1},mousedown:{bubbles:!0,cancelable:!0},mouseenter:{bubbles:!1,cancelable:!1},mouseleave:{bubbles:!1,cancelable:!1},mousemove:{bubbles:!0,cancelable:!0},mouseout:{bubbles:!0,cancelable:!0},mouseover:{bubbles:!0,cancelable:!0},mouseup:{bubbles:!0,cancelable:!0},mousewheel:{bubbles:!0},orientationchange:{bubbles:!1},paste:{bubbles:!0,cancelable:!0},progress:{bubbles:!1,cancelable:!1},reset:{bubbles:!0,cancelable:!1},resize:{bubbles:!1,cancelable:!1},scroll:{bubbles:function(e){return!!e.defaultView},cancelable:!1},select:{bubbles:!0,cancelable:!1},submit:{bubbles:!0,cancelable:!0},touchcancel:{bubbles:!0,cancelable:!1},touchend:{bubbles:!0,cancelable:!0},touchmove:{bubbles:!0,cancelable:!0},touchstart:{bubbles:!0,cancelable:!0},unload:{bubbles:!1,cancelable:!1},wheel:{bubbles:!0,cancelable:!0},pointerdown:{bubbles:!0,cancelable:!0},pointerup:{bubbles:!0,cancelable:!0},pointerenter:{bubbles:!1,cancelable:!0},pointercancel:{bubbles:!0,cancelable:!0},pointerout:{bubbles:!0,cancelable:!0},pointerover:{bubbles:!0,cancelable:!0},pointerleave:{bubbles:!1,cancelable:!0},pointermove:{bubbles:!0,cancelable:!0},MSPointerDown:{bubbles:!0,cancelable:!0},MSPointerMove:{bubbles:!0,cancelable:!0},MSPointerUp:{bubbles:!0,cancelable:!0},MSPointerOver:{bubbles:!0,cancelable:!0},MSPointerOut:{bubbles:!0,cancelable:!0},MSPointerHover:{bubbles:!0,cancelable:!0}}},_DOMPasteboardElement:{value:null,enumerable:!1},_delegate:{value:null,enumerable:!1},delegate:{enumerable:!1,get:function(){return this._delegate},set:function(e){this._delegate=e}},_application:{value:null,enumerable:!1},application:{enumerable:!1,get:function(){return this._application},set:function(e){this._application=e}},_registeredWindows:{value:null,enumerable:!1},_windowsAwaitingFinalRegistration:{value:new d,enumerable:!1},initWithWindow:{enumerable:!1,value:function(e){if(this._registeredWindows)throw"EventManager has already been initialized";return this.registerWindow(e),this}},registerWindow:{enumerable:!1,value:function(e){if(e.defaultEventManager&&e.defaultEventManager!==this)throw"EventManager cannot register a window already registered to another EventManager";if(this._registeredWindows&&this._registeredWindows.indexOf(e)>=0)throw"EventManager cannot register a window more than once";if(this._registeredWindows||(this._registeredWindows=[]),!this._windowsAwaitingFinalRegistration.has(e)){if(e.Element.prototype.nativeAddEventListener=e.Element.prototype.addEventListener,Object.defineProperty(e,"nativeAddEventListener",{configurable:!0,value:e.addEventListener}),e.document.nativeAddEventListener=e.document.addEventListener,e.XMLHttpRequest.prototype.nativeAddEventListener=e.XMLHttpRequest.prototype.addEventListener,e.Worker&&(e.Worker.prototype.nativeAddEventListener=e.Worker.prototype.addEventListener),e.MediaController&&(e.MediaController.prototype.nativeAddEventListener=e.MediaController.prototype.addEventListener),e.Element.prototype.nativeRemoveEventListener=e.Element.prototype.removeEventListener,Object.defineProperty(e,"nativeRemoveEventListener",{configurable:!0,value:e.removeEventListener}),e.document.nativeRemoveEventListener=e.document.removeEventListener,e.XMLHttpRequest.prototype.nativeRemoveEventListener=e.XMLHttpRequest.prototype.removeEventListener,e.Worker&&(e.Worker.prototype.nativeRemoveEventListener=e.Worker.prototype.removeEventListener),e.MediaController&&(e.MediaController.prototype.nativeRemoveEventListener=e.MediaController.prototype.removeEventListener),Object.defineProperty(e,"addEventListener",{configurable:!0,value:e.XMLHttpRequest.prototype.addEventListener=e.Element.prototype.addEventListener=e.document.addEventListener=function(t,n,i){return e.defaultEventManager.registerEventListener(this,t,n,!!i)}}),e.Worker&&(e.Worker.prototype.addEventListener=e.addEventListener),e.MediaController&&(e.MediaController.prototype.addEventListener=e.addEventListener),Object.defineProperty(e,"removeEventListener",{configurable:!0,value:e.XMLHttpRequest.prototype.removeEventListener=e.Element.prototype.removeEventListener=e.document.removeEventListener=function(t,n,i){return e.defaultEventManager.unregisterEventListener(this,t,n,!!i)}}),e.Worker&&(e.Worker.prototype.removeEventListener=e.removeEventListener),e.MediaController&&(e.MediaController.prototype.removeEventListener=e.removeEventListener),e.HTMLDivElement.prototype.addEventListener!==e.Element.prototype.nativeAddEventListener&&e.HTMLElement&&"addEventListener"in e.HTMLElement.prototype){var n,i,r=Object.getOwnPropertyNames(e),s=0,l=r.length;for(s;s<l;s++)n=r[s],n.match(/^HTML\w*Element$/)&&"function"==typeof n&&(i=n.prototype,i.nativeAddEventListener=i.addEventListener,i.addEventListener=e.Element.prototype.addEventListener,i.nativeRemoveEventListener=i.removeEventListener,i.removeEventListener=e.Element.prototype.removeEventListener)}o.defineProperty(e.Element.prototype,"component",{get:function(){return a._elementEventHandlerByElement.get(this)},enumerable:!1}),a=e.defaultEventManager=t.defaultEventManager=this,this._registeredWindows.push(e),this._windowsAwaitingFinalRegistration.set(e,e),/loaded|complete|interactive/.test(e.document.readyState)?this._finalizeWindowRegistration(e):e.document.addEventListener("DOMContentLoaded",this,!0),this._evaluateShouldDispatchEventCondition()}}},_finalizeWindowRegistration:{enumerable:!1,value:function(e){if(!this._windowsAwaitingFinalRegistration.has(e))throw"EventManager wasn't expecting to register this window";this._windowsAwaitingFinalRegistration["delete"](e),this._listenToWindow(e)}},unregisterWindow:{enumerable:!1,value:function(e){if(this._registeredWindows.indexOf(e)<0)throw"EventManager cannot unregister an unregistered window";if(this._registeredWindows=this._registeredWindows.filter(function(t){return e!==t}),delete e.defaultEventManager,e.Element.prototype.addEventListener=e.Element.prototype.nativeAddEventListener,Object.defineProperty(e,"addEventListener",{configurable:!0,value:e.nativeAddEventListener}),e.document.addEventListener=e.document.nativeAddEventListener,e.XMLHttpRequest.prototype.addEventListener=e.XMLHttpRequest.prototype.nativeAddEventListener,e.Worker&&(e.Worker.prototype.addEventListener=e.Worker.prototype.nativeAddEventListener),e.Element.prototype.removeEventListener=e.Element.prototype.nativeRemoveEventListener,Object.defineProperty(e,"removeEventListener",{configurable:!0,value:e.nativeRemoveEventListener}),e.document.removeEventListener=e.document.nativeRemoveEventListener,e.XMLHttpRequest.prototype.removeEventListener=e.XMLHttpRequest.prototype.nativeRemoveEventListener,e.Worker&&(e.Worker.prototype.removeEventListener=e.Worker.prototype.nativeRemoveEventListener),e.HTMLDivElement.prototype.nativeAddEventListener!==e.Element.prototype.addEventListener&&e.HTMLElement&&"addEventListener"in e.HTMLElement.prototype&&e.Components&&e.Components.interfaces){var t,n;for(t in Components.interfaces)t.match(/^nsIDOMHTML\w*Element$/)&&(t=t.replace(/^nsIDOM/,""),(t=window[t])&&(n=t.prototype,n.addEventListener=n.nativeAddEventListener,delete n.nativeAddEventListener,n.removeEventListener=n.nativeRemoveEventListener,delete n.nativeRemoveEventListener))}delete e.Element.prototype.nativeAddEventListener,delete e.nativeAddEventListener,delete e.document.nativeAddEventListener,delete e.XMLHttpRequest.prototype.nativeAddEventListener,e.Worker&&delete e.Worker.prototype.nativeAddEventListener,delete e.Element.prototype.nativeRemoveEventListener,delete e.nativeRemoveEventListener,delete e.document.nativeRemoveEventListener,delete e.XMLHttpRequest.prototype.nativeRemoveEventListener,e.Worker&&delete e.Worker.prototype.nativeRemoveEventListener,delete e.Element.prototype.component,this._stopListeningToWindow(e)}},unregisterWindows:{enumerable:!1,value:function(){this._registeredWindows.forEach(this.unregisterWindow)}},registeredEventListeners:{enumerable:!1,value:{}},registeredEventListenersForEventType_:{value:function(e){var t=this._registeredCaptureEventListeners.get(e),n=this._registeredBubbleEventListeners.get(e),i=null;return t&&t.forEach(function(e,t,n){e&&e.length>0&&(i||(i=[]),e.forEach(function(e){i.push(e)}))}),n&&n.forEach(function(e,t,n){e&&e.length>0&&(i||(i=[]),e.forEach(function(e){i.push(e)}))}),i}},registeredEventListenersForEventType_onTarget_:{enumerable:!1,value:function(e,t){var n,i=this._registeredCaptureEventListeners.get(e),r=this._registeredBubbleEventListeners.get(e),a=null;return e&&t&&(i||r)?(n=i?i.get(t):null,n&&(a||(a=n)),n=r?r.get(t):null,n&&(a=a?a.union(n):n),a):null}},registeredEventListenersForEventType_onTarget_phase_:{enumerable:!1,value:function(e,t,n){return t?this._registeredEventListenersForEventType_onTarget_registeredEventListeners_(e,t,n?this._registeredCaptureEventListeners:this._registeredBubbleEventListeners):null}},_registeredEventListenersForEventType_onTarget_registeredEventListeners_:{value:function(e,t,n){var i=n.get(e);return i?i.get(t):null},enumerable:!1},registeredEventListenersOnTarget_:{value:function(e){var t,n,i,r=this._registeredCaptureEventListeners,a=this._registeredBubbleEventListeners,o=[];for(i=r.keys();t=i.next().value;)n=r.get(t),n.has(e)&&o.push(t);for(i=a.keys();t=i.next().value;)n=_registeredBubbleEventListenersget(t),n.has(e)&&o.push(t);return o}},_registeredCaptureEventListeners:{value:null},_registeredBubbleEventListeners:{value:null},registerEventListener:{enumerable:!1,value:function(e,t,n,i){var r;return r=this._registerEventListener(e,t,n,i?this._registeredCaptureEventListeners:this._registeredBubbleEventListeners)}},_registerEventListener:{enumerable:!1,value:function(e,t,n,i){var r,a=i.get(t),o=!1,s=!1;return a?a.has(e)?(r=a.get(e),Array.isArray(r)?r.indexOf(n)!==-1?s=!0:(r.push(n),s=!0):(r!==n&&(r=[r,n],a.set(e,r)),s=!0)):(a.set(e,n),o=!0):(i.set(t,a=new v),a.set(e,n),o=!0,s=!0),o&&"function"==typeof e.nativeAddEventListener&&this._observeTarget_forEventType_(e,t),s}},unregisterEventListener:{enumerable:!1,value:function(e,t,n,i){return i?this._unregisterEventListener(e,t,n,this._registeredCaptureEventListeners,this._registeredBubbleEventListeners):this._unregisterEventListener(e,t,n,this._registeredBubbleEventListeners,this._registeredCaptureEventListeners)}},_unregisterEventListener:{enumerable:!1,value:function(e,t,n,i,r){var a,o,s=i.get(t);if(s&&(a=s.get(e)))return a===n?(s.set(e,null),void this._unregisterTargetForEventTypeIfNeeded(e,t,a,i,r)):void(Array.isArray(a)&&a.indexOf(n)!==-1&&(this._currentDispatchedTargetListeners.has(a)?(o=this._currentDispatchedTargetListeners.get(a),o||this._currentDispatchedTargetListeners.set(a,o=new v),o.set(n,!0)):(this.spliceOne(a,a.indexOf(n)),this._unregisterTargetForEventTypeIfNeeded(e,t,a,i,r))))}},_unregisterTargetForEventTypeIfNeeded:{value:function(e,t,n,i,r){if(!Array.isArray(n)||0===n.length){var a=i.get(t),o=r.get(t);a["delete"](e),0===a.size&&(!o||o&&0===o.size)&&this._stopObservingTarget_forEventType_(e,t)}}},actualDOMTargetForEventTypeOnTarget:{value:function(e,t){if(t.nativeAddEventListener){if(t.defaultView)return t;var n,i=this.eventDefinitions[e];return i?(n=typeof i.bubbles===g?i.bubbles(t):i.bubbles,n?t.screen?t.document:t.ownerDocument:t):t}return null}},_observedTarget_byEventType_:{value:null},_observeTarget_forEventType_:{enumerable:!1,value:function(e,t){var n;!(n=this.actualDOMTargetForEventTypeOnTarget(t,e))||this._observedTarget_byEventType_[t]&&this._observedTarget_byEventType_[t].has(n)||(this._observedTarget_byEventType_[t]||(this._observedTarget_byEventType_[t]=new v),this._observedTarget_byEventType_[t].set(n,this),n.nativeAddEventListener(t,this,!0))}},_stopObservingTarget_forEventType_:{enumerable:!1,value:function(e,t){var n;n=this.actualDOMTargetForEventTypeOnTarget(t,e),n&&(this._observedTarget_byEventType_[t]["delete"](n),n.nativeRemoveEventListener(t,this,!0))}},_activationHandler:{enumerable:!0,value:null},_listenToWindow:{enumerable:!1,value:function(e){if(!this._activationHandler){var t=this;this._activationHandler=function(e){var n,i=e.type,r="mouseenter"!==i&&"pointerenter"!==i;if(e.changedTouches){n=e.changedTouches.length;for(var a=0;a<n;a++)t._prepareComponentsForActivation(e.changedTouches[a].target,r)}else t._prepareComponentsForActivation(e.target,r)}}if(window.PointerEvent?(e.nativeAddEventListener("pointerdown",this._activationHandler,!0),e.document.nativeAddEventListener("pointerenter",this._activationHandler,!0)):window.MSPointerEvent&&window.navigator.msPointerEnabled?(e.nativeAddEventListener("MSPointerDown",this._activationHandler,!0),e.document.nativeAddEventListener("mouseenter",this._activationHandler,!0)):(e.nativeAddEventListener("touchstart",this._activationHandler,!0),e.nativeAddEventListener("mousedown",this._activationHandler,!0),e.document.nativeAddEventListener("mouseenter",this._activationHandler,!0)),e.nativeAddEventListener("focus",this._activationHandler,!0),this.application){var n,i=this.registeredEventListenersOnTarget_(this.application);for(n in i)this._observeTarget_forEventType_(e,n)}}},_stopListeningToWindow:{enumerable:!1,value:function(e){var t,n,i=this.registeredEventListenersOnTarget_(this.application),r=this.registeredEventListenersOnTarget_(e);for(t in i)this._stopObservingTarget_forEventType_(e,t);for(t in r)this._stopObservingTarget_forEventType_(e,t);(n=this._listeningWindowOnTouchCancel.indexOf(e))>-1&&this.spliceOne(this._listeningWindowOnTouchCancel,n)}},_resetRegisteredEventListeners:{enumerable:!1,value:function(e){var t,n,i=this;for(t in e)n=e.get(t),n&&n.forEach(function(e,n,r){i._stopObservingTarget_forEventType_(n,t)})}},reset:{enumerable:!1,value:function(){this._resetRegisteredEventListeners(this._registeredCaptureEventListeners),this._resetRegisteredEventListeners(this._registeredBubbleEventListeners),this._claimedPointers=new v,this._registeredCaptureEventListeners=new v,this._registeredBubbleEventListeners=new v}},unload:{enumerable:!1,value:function(){this._stopListening()}},_bubbleMethodNameByEventType_:{value:new v},_bubbleMethodNameByEventTypeIdentifier_:{value:new v},methodNameForBubblePhaseOfEventType:{enumerable:!1,value:function(e,t,n,i){var r;return t?(r=this._bubbleMethodNameByEventTypeIdentifier_.get(e)||this._bubbleMethodNameByEventTypeIdentifier_.set(e,new v).get(e),r.get(t)||r.set(t,"handle"+(i||t.toCapitalized())+(n||e.toCapitalized())).get(t)):this._bubbleMethodNameByEventType_.get(e)||this._bubbleMethodNameByEventType_.set(e,"handle"+(n||e.toCapitalized())).get(e)}},_captureMethodNameByEventType_:{value:new v},_catptureMethodNameByEventTypeIdentifier_:{value:new v},methodNameForCapturePhaseOfEventType:{enumerable:!1,value:function(e,t,n,i){var r;return t?(r=this._catptureMethodNameByEventTypeIdentifier_.get(e)||this._catptureMethodNameByEventTypeIdentifier_.set(e,new v).get(e),r.get(t)||r.set(t,"capture"+(i||t.toCapitalized())+(n||e.toCapitalized())).get(t)):this._captureMethodNameByEventType_.get(e)||this._captureMethodNameByEventType_.set(e,"capture"+(n||e.toCapitalized())).get(e)}},_claimedPointers:{enumerable:!1,value:null},componentClaimingPointer:{value:function(e){return this._claimedPointers.get(e)}},isPointerClaimedByComponent:{value:function(e,t){if(!t)throw"Must specify a valid component to see if it claims the specified pointer, '"+t+"' is not valid.";return this._claimedPointers.get(e)===t}},claimPointer:{value:function(e,t){if(!e&&0!==e)throw"Must specify a valid pointer to claim, '"+e+"' is not valid.";if(!t)throw"Must specify a valid component to claim a pointer, '"+t+"' is not valid.";var n=this._claimedPointers.get(e);return n===t||(n?!!n.surrenderPointer(e,t)&&(this._claimedPointers.set(e,t),!0):(this._claimedPointers.set(e,t),!0))}},forfeitPointer:{value:function(e,t){if(t!==this._claimedPointers.get(e))throw"Not allowed to forfeit pointer '"+e+"' claimed by another component";this._claimedPointers["delete"](e)}},forfeitAllPointers:{value:function(e){for(var t,n,i=this._claimedPointers.keys();t=i.next().value;)n=this._claimedPointers.get(t),e===n&&this._claimedPointers["delete"](t)}},_isStoringPointerEvents:{enumerable:!1,value:!1},isStoringPointerEvents:{enumerable:!0,get:function(){return this._isStoringPointerEvents},set:function(e){e===!0?this._isStoringPointerEvents||(this._isStoringPointerEvents=!0,window.PointerEvent||window.MSPointerEvent&&window.navigator.msPointerEnabled?Object.defineProperty(s.prototype,"velocity",{get:function(){return a.pointerMotion(this.pointerId).velocity}}):window.Touch&&Object.defineProperty(Touch.prototype,"velocity",{get:function(){return a.pointerMotion(this.identifier).velocity}})):(this._isStoringPointerEvents=!1,this._pointerStorage.memory={},this._isMouseDragging=!1)}},_isStoringMouseEventsWhileDraggingOnly:{enumerable:!1,value:!0},isStoringMouseEventsWhileDraggingOnly:{enumerable:!0,get:function(){return this._isStoringMouseEventsWhileDraggingOnly},set:function(e){this._isStoringMouseEventsWhileDraggingOnly=e===!0}},_isMouseDragging:{enumerable:!1,value:!1},_pointerStorage:{enumerable:!1,value:{memory:{},velocity:{},add:function(e,t){this.memory[e]||(this.memory[e]={data:new Array(32),size:0,pos:0}),this.memory[e].data[this.memory[e].pos]=t,this.memory[e].size<this.memory[e].data.length&&this.memory[e].size++,this.memory[e].pos=(this.memory[e].pos+1)%this.memory[e].data.length},remove:function(e){delete this.memory[e]},clear:function(e){this.memory[e]&&(this.memory[e].size=0)},getMemory:function(e){return this.memory[e]},isStored:function(e){return this.memory[e]&&this.memory[e].size>0},storeEvent:function(e){var t=c.isBrowserSupportPointerEvents,n=e instanceof s?e._event:e,i=n.pointerType;if(t&&("mouse"===i||window.MSPointerEvent&&i===window.MSPointerEvent.MSPOINTER_TYPE_MOUSE)||!t&&n instanceof MouseEvent)switch(e.type){case"pointerdown":case"MSPointerDown":case"mousedown":a._isMouseDragging=!0;case"pointermove":case"MSPointerMove":case"mousemove":a._isStoringMouseEventsWhileDraggingOnly?a._isMouseDragging&&this._storeMouse(e):this._storeMouse(e);break;case"pointerup":case"MSPointerUp":case"mouseup":this._storeMouse(e)}else if(t&&("touch"===i||window.MSPointerEvent&&i===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH)||void 0!==window.TouchEvent&&!t&&n instanceof TouchEvent)switch(n.type){case"pointerdown":case"MSPointerDown":case"pointermove":case"MSPointerMove":case"pointerup":case"MSPointerUp":this._storeTouch(n.pointerId,n.clientX,n.clientY,n.timeStamp);break;case"touchstart":case"touchmove":this._storeTouches(n.touches,n.timeStamp);break;case"touchend":this._storeTouches(n.changedTouches,n.timeStamp)}},removeEvent:function(e){var t=c.isBrowserSupportPointerEvents,n=e instanceof s?e._event:e;if(t&&("mouse"===e.pointerType||window.MSPointerEvent&&e.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_MOUSE)||!t&&n instanceof MouseEvent)"mouseup"!==e.type&&"pointerup"!==e.type&&"MSPointerUp"!==e.type||(a._isMouseDragging=!1,a._isStoringMouseEventsWhileDraggingOnly&&this.clear("mouse"));else if((t&&("touch"===e.pointerType||window.MSPointerEvent&&e.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH)||void 0!==window.TouchEvent&&!t&&n instanceof TouchEvent)&&("touchend"===e.type||"pointerup"===e.type||"MSPointerUp"===e.type))if(e.changedTouches)for(var i,r=0,o=e.changedTouches;i=o[r];r++)this.remove(i.identifier);else this.remove(e.pointerId)},_storeMouse:function(e){this.add("mouse",{clientX:e.clientX,clientY:e.clientY,timeStamp:e.timeStamp}),Object.defineProperty(e,"velocity",{get:function(){return a.pointerMotion("mouse").velocity}})},_storeTouches:function(e,t){for(var n,i=0;n=e[i];i++)this._storeTouch(n.identifier,n.clientX,n.clientY,t)},_storeTouch:function(e,t,n,i){this.add(e,{clientX:t,clientY:n,timeStamp:i})}}},_getPointerVelocityData:{enumerable:!1,value:function(e){var t,n,i,r,o,s,l,u,v,d=0,c=!0,h={x:[],y:[],time:[]};for(t=a._pointerStorage.getMemory(e),n=t.data.length,i=t.data[(t.pos-1+n)%n],r=o=s=i.timeStamp,l=i.clientX,u=i.clientY;c&&o>r-350&&d<t.size;)i=t.data[(t.pos-d-1+n)%n],o=i.timeStamp,v=l*l+u*u,v>2&&s-o<=50?(h.x.push(i.clientX),h.y.push(i.clientY),h.time.push(o),s=o,l=i.clientX,u=i.clientY,d++):c=!1;return h}},_fitPointerCurve:{enumerable:!1,value:function(e,t){var n,i,r,a,o,s,l,u,v,d,c,h,p,b,m,E,g,f,_,y,T,L,w,M,P,S,O,D,A,C,k,W,R,H,F,B,z,I,N=1e-4,x=t.length;do{for(c=h=p=b=m=E=f=_=y=T=L=w=P=S=O=D=A=C=W=R=H=F=B=z=0,d=0;d<x;d++)o=t[d],s=o.t,u=s*s,v=u*s,l=o.v,g=N*(6*(u-s)-v+2),M=6*N*(v-2*u+s),k=6*N*(u-v),I=2*N*v,E+=g*g,w+=M*M,C+=k*k,z+=I*I,c+=l*g,f+=l*M,P+=l*k,W+=l*I,p-=g,y-=M,O-=k,H-=I,h-=g*s,_-=M*s,S-=k*s,R-=I*s,b-=g*u,T-=M*u,D-=k*u,F-=I*u,m-=g*v,L-=M*v,A-=k*v,B-=I*v;N*=2}while(0===E||0===w||0===C||0===z);for(s=N/E,c*=s,h*=3*s,p*=s,b*=3*s,m*=s,s=N/w,f*=s,_*=3*s,y*=s,T*=3*s,L*=s,s=N/C,P*=s,S*=3*s,O*=s,D*=3*s,A*=s,s=N/z,W*=s,R*=3*s,H*=s,F*=3*s,B*=s,E=e[0],w=e[1],C=e[2],z=e[3],n=3*(w-C)+z-E,i=E+C-2*w,r=w-E,a=E,d=0;d<20;d++)s=c+a*p+r*h+i*b+n*m,E+=s,a+=s,n-=s,i+=s,r-=s,s=f+a*y+r*_+i*T+n*L,w+=s,n+=3*s,i-=s+s,r+=s,s=P+a*O+r*S+i*D+n*A,C+=s,n-=3*s,i+=s,s=W+a*H+r*R+i*F+n*B,z+=s,n+=s;e[0]=E,e[1]=w,e[2]=C,e[3]=z}},_pointerBezierValue:{enumerable:!1,value:function(e,t){var n=1-e;return n*n*n*t[0]+3*n*n*e*t[1]+3*n*e*e*t[2]+e*e*e*t[3]}},_calculatePointerVelocity:{enumerable:!1,value:function(e,t){var n,i,r=e.length,a=e[0],o=e[0],s=0;for(i=1;i<r;i++)e[i]<a&&(a=e[i],s=i);if(n=o-a){if(r>5){var l,u,v,d=[];for(i=0;i<r;i++)d[i]={v:t[i],t:(e[i]-a)/n};return l=d[s].v,u=d[0].v,v=[l,(2*l+u)/3,(l+2*u)/3,u],this._fitPointerCurve(v,d),5e3*(this._pointerBezierValue(.8,v)-this._pointerBezierValue(.6,v))/n}return r>1?1e3*(t[0]-t[s])/n:0}return 0}},pointerMotion:{value:function(e){return a._pointerStorage.isStored(e)?{velocity:(new h).initWithIdentifier(e)}:void 0}},monitorDOMModificationInEventHandling:{value:!1},domModificationEventHandler:{value:o.specialize({handleEvent:{value:function(e){throw"DOM Modified"}},captureDOMSubtreeModified:{value:function(e){throw"DOMSubtreeModified"}},captureDOMAttrModified:{value:function(e){throw"DOMAttrModified"}},captureDOMCharacterDataModified:{value:function(e){throw"DOMCharacterDataModified"}}})},_trackingTouchStartList:{value:null},_trackingTouchEndList:{value:null},_trackingTouchTimeoutIDs:{value:null},_wouldTouchTriggerSimulatedEvent:{value:function(e){switch(e.type){case"touchstart":case"touchend":return!0;default:return!1}}},_couldEventBeSimulated:{value:function(e){switch(e.type){case"mousedown":case"mouseup":case"click":return!0;default:return!1}}},_listeningWindowOnTouchCancel:{value:[]},_findWindowFromEvent:{value:function(e){var t,n=e.target;return n&&(t=n instanceof Window?n:n.defaultView instanceof Window?n.defaultView:n.ownerDocument&&n.ownerDocument.defaultView?n.ownerDocument.defaultView:null),t}},_isWindowListeningOnTouchCancel:{value:function(e){return this._registeredWindows.indexOf(e)>-1&&this._listeningWindowOnTouchCancel.indexOf(e)>-1}},_listenToTouchCancelIfNeeded:{value:function(e){var t=this._findWindowFromEvent(e);if(t&&!this._isWindowListeningOnTouchCancel(t)){var n=this;t.addEventListener("touchcancel",function(e){for(var t,i=e.changedTouches,r=n._trackingTouchStartList,a=0,o=i.length;a<o;a++)t=i[a].identifier,r.has(t)&&r["delete"](t)},!0),this._listeningWindowOnTouchCancel.push(t)}}},_blocksEmulatedEvents:{value:!0},blocksEmulatedEvents:{get:function(){return this._blocksEmulatedEvents},set:function(e){e!==this._blocksEmulatedEvents&&(this._blocksEmulatedEvents=e,this._evaluateShouldDispatchEventCondition())}},_shouldDispatchEventCondition:{value:void 0},_evaluateShouldDispatchEventCondition:{value:function(){this._shouldDispatchEventCondition=this.blocksEmulatedEvents&&!window.PointerEvent&&!(window.MSPointerEvent&&window.navigator.msPointerEnabled)}},_shouldDispatchEvent:{value:function(e){if(this._shouldDispatchEventCondition){if(this.environment.isIOSDevice&&this.environment.isWKWebView){if(0===e.timeStamp)return!1;if(this._couldEventBeSimulated(e)&&!e.hasOwnProperty("movementX"))return!1}if(this.environment.isAndroidDevice&&this._couldEventBeSimulated(e))return!1;if(this._wouldTouchTriggerSimulatedEvent(e)){var t=e.changedTouches;this._listenToTouchCancelIfNeeded(e);for(var n=0,i=t.length;n<i;n++)this._trackTouch(e,t[n])}else if(this._couldEventBeSimulated(e))return!this._isEmulatedEvent(e)}return!0}},_trackTouch:{value:function(e,t){var n=this._trackingTouchTimeoutIDs,i=this._trackingTouchStartList,r=this._trackingTouchEndList,a=t.identifier;if(t.timeStamp=e.timeStamp,"touchstart"===e.type){var o=n.get(a);o&&(clearTimeout(o),n["delete"](a)),i.set(a,t)}else n.set(a,setTimeout(function(){r["delete"](a),delete n[a]},400)),i["delete"](a),r.set(a,t)}},_isEmulatedEvent:{value:function(e){var t=this._findEmulatedEventIdentifierWithEventAndTrackingTouchList(e,this._trackingTouchStartList)>-1;if(!t){var n=this._trackingTouchEndList,i=this._findEmulatedEventIdentifierWithEventAndTrackingTouchList(e,n);if((t=i>-1)&&"click"===e.type){var r=this._trackingTouchTimeoutIDs,a=r.get(i);a&&(clearTimeout(a),n["delete"](i),r["delete"](i))}}return t}},_emulatedEventTimestampThreshold:{value:20},_emulatedEventRadiusThreshold:{value:20},_findEmulatedEventIdentifierWithEventAndTrackingTouchList:{value:function(e,t){var n,i,r,a=e.target,o=-1;for(r=t.keys();n=r.next().value;)if(i=t.get(n),i.target===a||this._couldEmulatedEventHaveWrongTarget(i,e,this._emulatedEventRadiusThreshold,this._emulatedEventTimestampThreshold)){o=n;break}return o}},_couldEmulatedEventHaveWrongTarget:{value:function(e,t,n,i){if(t.timeStamp-e.timeStamp<=i){var r=e.clientX-t.clientX,a=e.clientY-t.clientY;return r*r+a*a<=n*n}return!1}},_currentDispatchedTargetListeners:{value:null},_processCurrentDispatchedTargetListenersToRemove:{value:function(e,t,n,i){var r,a,o=this._currentDispatchedTargetListeners.get(i);o&&o.size>0&&(i.removeObjects(o),r=n?this._registeredCaptureEventListeners:this._registeredBubbleEventListeners,a=n?this._registeredBubbleEventListeners:this._registeredCaptureEventListeners,this._unregisterTargetForEventTypeIfNeeded(e,t,i,r,a))}},handleEvent:{enumerable:!1,value:function(e){if(!(e instanceof UIEvent)||this._shouldDispatchEvent(e)){this.monitorDOMModificationInEventHandling&&(document.body.addEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.addEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0));var t,n,i,r,a,o,l,u,v,d,c,h,f,_,y=e.type,T=y.toCapitalized(),L=e.bubbles,w=this._currentDispatchedTargetListeners,M=this._registeredCaptureEventListeners,P=this._registeredBubbleEventListeners;
for("DOMContentLoaded"===y&&(t=e.target.defaultView,t&&this._windowsAwaitingFinalRegistration.has(t)&&(this._finalizeWindowRegistration(t),e.target.removeEventListener("DOMContentLoaded",this,!0))),f="boolean"!=typeof e.propagationStopped?s.fromEvent(e):e,_=f.target,l=Element.isElement(_)||_ instanceof Document||_===window?this._eventPathForDomTarget(_):this._eventPathForTarget(_),_.identifier?(h=_.identifier.toCapitalized(),d=this.methodNameForCapturePhaseOfEventType(y,_.identifier,T,h),c=this.methodNameForBubblePhaseOfEventType(y,_.identifier,T,h)):(d=null,c=null),u=this.methodNameForCapturePhaseOfEventType(y,null,T),v=this.methodNameForBubblePhaseOfEventType(y,null,T),this.delegate&&typeof this.delegate.willDistributeEvent===g&&this.delegate.willDistributeEvent(f),this._isStoringPointerEvents&&this._pointerStorage.storeEvent(f),f.eventPhase=b,n=l.length-1;!f.propagationStopped&&(r=l[n]);n--)if(f.currentTarget=r,a=this._registeredEventListenersForEventType_onTarget_registeredEventListeners_(y,r,M))if(Array.isArray(a)){for(i=0,w.set(a,null);(o=a[i++])&&!f.immediatePropagationStopped;)this._invokeTargetListenerForEvent(r,o,f,d,u);this._processCurrentDispatchedTargetListenersToRemove(r,y,!0,a),w["delete"](a)}else this._invokeTargetListenerForEvent(r,a,f,d,u);if(!f.propagationStopped){if(f.eventPhase=m,f.currentTarget=r=_,a=this._registeredEventListenersForEventType_onTarget_registeredEventListeners_(y,r,M))if(Array.isArray(a)){for(i=0,w.set(a,null);(o=a[i++])&&!f.immediatePropagationStopped;)this._invokeTargetListenerForEvent(r,o,f,d,u);this._processCurrentDispatchedTargetListenersToRemove(r,y,!0,a),w["delete"](a)}else this._invokeTargetListenerForEvent(r,a,f,d,u);if(a=this._registeredEventListenersForEventType_onTarget_registeredEventListeners_(y,r,P))if(Array.isArray(a)){for(i=0,w.set(a,null);(o=a[i++])&&!f.immediatePropagationStopped;)this._invokeTargetListenerForEvent(r,o,f,c,v);this._processCurrentDispatchedTargetListenersToRemove(r,y,!1,a),w["delete"](a)}else this._invokeTargetListenerForEvent(r,a,f,c,v)}for(f.eventPhase=E,n=0;L&&!f.propagationStopped&&(r=l[n]);n++)if(f.currentTarget=r,a=this._registeredEventListenersForEventType_onTarget_registeredEventListeners_(y,r,P))if(Array.isArray(a)){for(i=0,w.set(a,null);(o=a[i++])&&!f.immediatePropagationStopped;)this._invokeTargetListenerForEvent(r,o,f,c,v);this._processCurrentDispatchedTargetListenersToRemove(r,y,!1,a),w["delete"](a)}else this._invokeTargetListenerForEvent(r,a,f,c,v);f.eventPhase=p,f.currentTarget=null,this._isStoringPointerEvents&&this._pointerStorage.removeEvent(e),this.monitorDOMModificationInEventHandling&&(document.body.removeEventListener("DOMSubtreeModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMAttrModified",this.domModificationEventHandler,!0),document.body.removeEventListener("DOMCharacterDataModified",this.domModificationEventHandler,!0))}}},_invokeTargetListenerForEvent:{value:function(e,t,n,i,r){var a=g;typeof t===a?t.call(e,n):i&&typeof t[i]===a?t[i](n):typeof t[r]===a?t[r](n):typeof t.handleEvent===a&&t.handleEvent(n)}},_prepareComponentsForActivation:{value:function(e,t){var n,i,r=e,a=r&&r.defaultView?r.defaultView:window,o=a.document?a.document:document,s=!1,l=null;do switch(r&&(i=this.eventHandlerForElement(r),i&&(s||(s=!0,l=this._findActiveTarget(i)),i.preparedForActivationEvents||i._prepareForActivationEvents())),n=r,r){case a:r=null;break;case o:r=a;break;case o.documentElement:r=o;break;default:r=r.parentNode}while(r&&n!==r);t&&(this.activeTarget=l)}},_findActiveTarget:{value:function(e){for(var t=null,n=new d;!t&&e&&!n.has(e);)n.set(e,!0),e.acceptsActiveTarget?t=e:e=e.nextTarget;return t}},_eventPathForTarget:{enumerable:!1,value:function(e){if(!e)return[];var t=e,n=this.application,i=[],r=new d;r.set(e,!0);do r.has(t)||(i.push(t),r.set(t,!0)),t=t.nextTarget,t&&!r.has(t)||(t=n),t&&r.has(t)&&(t=null);while(t);return i}},_eventPathForDomTarget:{enumerable:!1,value:function(e){if(!e)return[];var t,n=e,i=n&&n.defaultView?n.defaultView:window,r=i.document?i.document:document,a=this.application,o=[];do switch(n!==e&&o.push(n),t=n,n){case a:n=n.parentApplication,n&&(a=n);break;case i:n=a;break;case r:n=i;break;case r.documentElement:n=r;break;default:n=n.parentNode,n||(n=a)}while(n&&t!==n);return o}},_elementEventHandlerByElement:{enumerable:!1,value:null},registerEventHandlerForElement:{enumerable:!1,value:function(e,t){var n=this.eventHandlerForElement(t);n&&this.unregisterEventHandlerForElement(t),this._elementEventHandlerByElement.set(t,e)}},unregisterEventHandlerForElement:{enumerable:!1,value:function(e){this._elementEventHandlerByElement["delete"](e)}},eventHandlerForElement:{enumerable:!1,value:function(e){return this._elementEventHandlerByElement.get(e)}},_activeTarget:{value:null},activeTarget:{get:function(){return this._activeTarget||this.application},set:function(e){e||(e=this.application),e===this._activeTarget||this.activeTarget&&!this.activeTarget.surrendersActiveTarget(e)||e&&(e.willBecomeActiveTarget(this.activeTarget),this._activeTarget=e,e.didBecomeActiveTarget())}}})}}});