var Q=require("q"),URL=require("url2"),MimeTypes=require("mime"),FS=require("../fs"),StatusApps=require("./status"),RedirectApps=require("./redirect"),Negotiation=require("./negotiate"),HtmlApps=require("./html"),Deprecate=require("../deprecate");exports.File=function(e,t){return function(r,n){return exports.file(r,String(e),t)}},exports.FileTree=function(e,t){t||(t={}),t.notFound=t.notFound||StatusApps.notFound,t.file=t.file||exports.file,t.directory=t.directory||exports.directory,t.fs=t.fs||FS;var r=t.fs;return e=r.canonical(e),function(n,i){URL.parse(n.url);n.fs=r;var o=t.redirect||(n.permanent||t.permanent?RedirectApps.permanentRedirect:RedirectApps.temporaryRedirect);return Q.when(e,function(e){var s=r.join(e,n.pathInfo.slice(1));return Q.when(r.canonical(s),function(a){return t.followInsecureSymlinks&&(Deprecate.deprecationWarning("followInsecureSymlinks","followInsecureSymbolicLinks"),t.followInsecureSymbolicLinks=!0),r.contains(e,a)||t.followInsecureSymbolicLinks?s!==a&&t.redirectSymbolicLinks?o(n,r.relativeFromFile(s,a)):Q.when(r.stat(a),function(e){return e.isFile()?t.file(n,a,t.contentType,r):e.isDirectory()?t.directory(n,a,t.contentType,r):t.notFound(n,i)}):t.notFound(n,i)},function(e){return t.notFound(n,i)})})}},exports.file=function(e,t,r,n){return n=n||FS,r=r||MimeTypes.lookup(t),Q.when(n.stat(t),function(i){var o,s=exports.etag(i),a={flags:"rb"},c=200,u={"content-type":r,etag:s};if("range"in e.headers)if("if-range"in e.headers&&s!=e.headers["if-range"]);else{if(o=interpretFirstRange(e.headers.range,i.size),!o)return StatusApps.responseForStatus(e,416);if(o.end>i.size&&(o.end=i.size),o.end<=o.begin)return StatusApps.responseForStatus(e,416);c=206,u["content-range"]="bytes "+o.begin+"-"+(o.end-1)+"/"+i.size,u["content-length"]=""+(o.end-o.begin),a.begin=o.begin,a.end=o.end}else{if(s==e.headers["if-none-match"])return StatusApps.responseForStatus(e,304);u["content-length"]=""+i.size}return{status:c,headers:u,body:n.open(t,a),file:t,range:o}})};var rangesExpression=/^\s*bytes\s*=\s*(\d*\s*-\s*\d*\s*(?:,\s*\d*\s*-\s*\d*\s*)*)$/,rangeExpression=/^\s*(\d*)\s*-\s*(\d*)\s*$/,interpretRange=function(e,t){var r=rangeExpression.exec(e);if(r&&(""!=r[1]||""!=r[2])){var n,i;return""==r[1]?(n=0,i=+r[2]+1):""==r[2]?(n=+r[1],i=t):(n=+r[1],i=+r[2]+1),{begin:n,end:i}}},interpretFirstRange=exports.interpretFirstRange=function(e,t){var r=rangesExpression.exec(e);if(r){for(var n=r[1].split(/\s*,\s*/),i=interpretRange(n[0],t),o=0,s=n.length;o<s;o++){var a=interpretRange(n[o],t);if(!(a.begin<=i.end))return;i.end=a.end}return i}};exports.etag=function(e){return[e.node.ino,e.size,e.lastModified().getTime()].join("-")},exports.directory=function(e,t){var r=StatusApps.notFound(e);return r.directory=t,r},exports.ListDirectories=function(e,t){return t=t||exports.listDirectory,function(r){if(r.directoryIndex)throw new Error("DirectoryIndex must be used after ListDirectories");return r.listDirectories=!0,Q.fcall(e,r).then(function(e){return void 0!==e.directory?t(r,e):e})}},exports.listDirectory=function(e,t){if(e.location=URL.parse(e.path),e.location.file)return RedirectApps.redirect(e,e.location.file+"/");var r={};r["text/plain"]=exports.listDirectoryText,r["text/markdown"]=exports.listDirectoryMarkdown,e.handleHtmlFragmentResponse&&(r["text/html"]=exports.listDirectoryHtmlFragment),e.handleJsonResponse&&(r["application/json"]=exports.listDirectoryJson);var n=Negotiation.negotiate(e,r)||function(){return t};return n(e,t)},exports.listDirectoryHtmlFragment=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{"content-type":"text/html"},htmlTitle:"Directory Index",htmlFragment:{forEach:function(t){t('<ul class="directory-index">\n'),Object.keys(e).sort().forEach(function(r){var n=e[r],i="";"directory"===n.type&&(i="/"),t('    <li class="entry '+n.type+'"><a href="'+HtmlApps.escapeHtml(r+i)+'">'+HtmlApps.escapeHtml(r+i)+"</a></li>\n")}),t("</ul>\n")}}}})},exports.listDirectoryText=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){Object.keys(e).sort().forEach(function(r){var n=e[r],i="";"directory"===n.type&&(i="/"),t(r+i+"\n")})}}}})},exports.listDirectoryMarkdown=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{"content-type":"text/plain"},body:{forEach:function(t){t("\n# Directory Index\n\n"),Object.keys(e).forEach(function(r){var n=e[r],i="";"directory"===n.type&&(i="/"),t("-   "+r+i+"\n")}),t("\n")}}}})},exports.listDirectoryJson=function(e,t){return exports.listDirectoryData(e,t).then(function(e){return{status:200,headers:{},data:e}})},exports.listDirectoryData=function(e,t){if(!e.fs)throw new Error("Can't list a directory without a designated file system");var r=e.fs;return Q.invoke(r,"list",t.directory).then(function(e){return e.sort(),e.map(function(e){return Q.invoke(r,"stat",r.join(t.directory,e)).then(function(t){return t.isDirectory()?{name:e,stat:{type:"directory"}}:t.isFile()?{name:e,stat:{type:"file"}}:void 0},function(){})})}).all().then(function(e){var t={};return e.forEach(function(e){e&&(t[e.name]=e.stat)}),t})},exports.DirectoryIndex=function(e,t){return t=t||"index.html",function(r){return r.directoryIndex=!0,r.location=URL.parse(r.path),r.location.file===t?RedirectApps.redirect(r,"."):Q.fcall(e,r).then(function(n){if(void 0!==n.directory){if(r.location.file)return RedirectApps.redirect(r,r.location.file+"/");var i=r.fs.join(n.directory,t);return Q.invoke(r.fs,"isFile",i).then(function(i){return i?(r.url=URL.resolve(r.url,t),r.pathInfo+=t,e(r)):n})}return n})}};