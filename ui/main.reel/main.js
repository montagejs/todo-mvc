var Component=require("montage/ui/component").Component,RangeController=require("montage/core/range-controller").RangeController,Todo=require("core/todo").Todo,Serializer=require("montage/core/serialization/serializer/montage-serializer").MontageSerializer,Deserializer=require("montage/core/serialization/deserializer/montage-deserializer").MontageDeserializer,LOCAL_STORAGE_KEY="todos-montage";exports.Main=Component.specialize({_newTodoForm:{value:null},_newTodoInput:{value:null},todoListController:{value:null},constructor:{value:function(){this.todoListController=new RangeController,this.addPathChangeListener("todos.every{completed}",this,"handleTodosCompletedChanged"),this.defineBindings({todos:{"<-":"todoListController.content"},todosLeft:{"<-":"todos.filter{!completed}"},todosCompleted:{"<-":"todos.filter{completed}"}})}},_selectedFilter:{value:null},selectedFilter:{set:function(e){if(this._selectedFilter!==e&&(this._selectedFilter=e,this.todoListController)){var t=null;e&&(t="active"===e?"!completed":"completed"===e?"completed":null),this.todoListController.filterPath=t}},get:function(){return this._selectedFilter}},templateDidLoad:{value:function(){this.load()}},load:{value:function(){if(localStorage){var e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){var t=new Deserializer,o=this;t.init(e,require).deserializeObject().then(function(e){o.todoListController.content=e},function(t){console.error("Could not load saved tasks."),console.debug("Could not deserialize",e),console.log(t.stack)})}}}},save:{value:function(){if(localStorage){var e=this.todoListController.content,t=(new Serializer).initWithRequire(require);localStorage.setItem(LOCAL_STORAGE_KEY,t.serializeObject(e))}}},enterDocument:{value:function(e){if(e){if(this._newTodoForm.identifier="newTodoForm",this._newTodoForm.addEventListener("submit",this,!1),window.location&&window.location.hash){var t=window.location.hash.substring(2);"active"!==t&&"completed"!==t||(this._filterController.value=t)}this.addEventListener("destroyTodo",this,!0),window.addEventListener("beforeunload",this,!0)}}},captureDestroyTodo:{value:function(e){this.destroyTodo(e.detail.todo)}},createTodo:{value:function(e){var t=(new Todo).initWithTitle(e);return this.todoListController.add(t),t}},destroyTodo:{value:function(e){return this.todoListController["delete"](e),e}},_allCompleted:{value:null},allCompleted:{get:function(){return this._allCompleted},set:function(e){this._allCompleted=e,this.todoListController&&this.todoListController.content&&this.todoListController.content.forEach(function(t){t.completed=e})}},todos:{value:null},todosLeft:{value:null},todosCompleted:{value:null},handleNewTodoFormSubmit:{value:function(e){e.preventDefault();var t=this._newTodoInput.value.trim();""!==t&&(this.createTodo(t),this._newTodoInput.value=null)}},handleTodosCompletedChanged:{value:function(e){this._allCompleted=e,this.dispatchOwnPropertyChange("allCompleted",e)}},handleClearCompletedButtonAction:{value:function(){var e=this.todoListController.content.filter(function(e){return e.completed});e.length>0&&this.todoListController.deleteEach(e)}},captureBeforeunload:{value:function(){this.save()}}});